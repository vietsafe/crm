<!doctype html>
<html lang="vi">
<head>
  <!-- =========================================================
       CRM Bootstrap Full – Single HTML (Modified per request 2025-07-28)
       Changes:
       - Disable Services module (hidden UI, no render calls).
       - Role-based access: admin/BOM = full; user = Dashboard, Customers (limited view), Quotes, Contracts.
       - Quotes simplified: ID, customer, project, description, amount, status, send_count, pdf_url.
       - Keep all other parts intact.
       ========================================================= -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>CRM • Supabase • Bootstrap Admin</title>

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
  <!-- Supabase JS v2 (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

  <style>
    html, body { height: 100%; background-color: #f8f9fa; }
    .sidebar { width: 280px; min-height: 100vh; position: sticky; top: 0; left: 0; border-right: 1px solid #e9ecef; background:#fff; }
    .sidebar .nav-link { border-radius: .5rem; color: #334155; }
    .sidebar .nav-link.active, .sidebar .nav-link:hover { background-color: #e7f1ff; color: #0d6efd; }
    .content-wrap { margin-left: 0; }
    @media (min-width: 992px) { .content-wrap { margin-left: 280px; } .sidebar { position: fixed; } }
    .card-shadow { box-shadow: 0 8px 24px rgba(0,0,0,.06); border:1px solid #eef2f7; border-radius:1rem; }

    .suggestions { position:absolute; z-index:1050; background:#fff; border:1px solid #e5e7eb; border-radius:.5rem; max-height:260px; overflow-y:auto; width:100%; box-shadow:0 10px 22px rgba(0,0,0,.08); }
    .suggestion-item { padding:.5rem .75rem; cursor:pointer; }
    .suggestion-item:hover { background:#f5f7fb; }

    .section-anchor { scroll-margin-top: 80px; }

    .auth-overlay{position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(15,23,42,.55); backdrop-filter:blur(2px); z-index:3000;}
    .auth-card{width:420px; border-radius:1rem; box-shadow:0 20px 40px rgba(0,0,0,.2);}  
  </style>
</head>
<body>

  <!-- ===== AUTH OVERLAY (Google + whitelist user_profiles) ===== -->
  <div id="authOverlay" class="auth-overlay d-none">
    <div class="card auth-card">
      <div class="card-body text-center p-4">
        <div class="mb-3"><i class="bi bi-shield-lock" style="font-size:2.5rem;"></i></div>
        <h5 class="fw-bold mb-2">Đăng nhập VSEC CRM</h5>
        <p class="text-muted small mb-4">Chỉ chấp nhận email nằm trong bảng <code>user_profiles</code> và <code>active = true</code>.</p>
        <button id="btnGoogle" class="btn btn-dark w-100 mb-2"><i class="bi bi-google me-2"></i>Đăng nhập với Google</button>
        <div id="authError" class="text-danger small mt-2"></div>
      </div>
    </div>
  </div>

  <!-- ========================= SIDEBAR ========================= -->
  <aside class="sidebar p-3">
    <a class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-decoration-none">
      <span class="fs-5 fw-bold"><i class="bi bi-layout-text-sidebar-reverse me-2"></i>CRM Admin</span>
    </a>
    <hr>
    <ul class="nav nav-pills flex-column gap-1" id="sidebarNav">
      <li class="nav-item"><a class="nav-link active" data-page="dashboard"><i class="bi bi-speedometer2 me-2"></i>Dashboard</a></li>
      <li class="nav-item"><a class="nav-link" data-page="customers"><i class="bi bi-people me-2"></i>Customers</a></li>
      <!-- Services DISABLED -->
      <li class="nav-item" id="navServices" style="display:none"><a class="nav-link" data-page="services"><i class="bi bi-box-seam me-2"></i>Services</a></li>
      <li class="nav-item"><a class="nav-link" data-page="projects"><i class="bi bi-kanban me-2"></i>Projects</a></li>
      <li class="nav-item"><a class="nav-link" data-page="opportunities"><i class="bi bi-bullseye me-2"></i>Opportunities</a></li>
      <li class="nav-item"><a class="nav-link" data-page="quotes"><i class="bi bi-receipt me-2"></i>Quotes</a></li>
      <li class="nav-item"><a class="nav-link" data-page="contracts"><i class="bi bi-file-earmark-text me-2"></i>Contracts</a></li>
      <li class="nav-item"><a class="nav-link" data-page="users" id="navUsers"><i class="bi bi-person-gear me-2"></i>Users</a></li>
    </ul>
    <hr>
    <div class="dropdown">
      <a class="d-flex align-items-center text-decoration-none dropdown-toggle" data-bs-toggle="dropdown">
        <img src="https://ui-avatars.com/api/?name=CRM&background=0D6EFD&color=fff" alt="" width="32" height="32" class="rounded-circle me-2">
        <strong id="currentEmail">guest@local</strong>
      </a>
      <ul class="dropdown-menu shadow">
        <li><a class="dropdown-item" href="#" id="btnSignOut"><i class="bi bi-box-arrow-right me-2"></i>Đăng xuất</a></li>
      </ul>
    </div>
  </aside>

  <!-- ========================= MAIN ========================= -->
  <main class="content-wrap">
    <div class="container-fluid py-4">

      <!-- DASHBOARD -->
      <section id="page-dashboard" class="section-anchor">
        <div class="d-flex align-items-center mb-4">
          <h1 class="h3 mb-0"><i class="bi bi-speedometer2 me-2"></i>Dashboard</h1>
        </div>
        <div class="row g-4">
          <div class="col-12 col-sm-6 col-lg-3"><div class="card card-shadow"><div class="card-body"><h6 class="text-secondary text-uppercase mb-1">Customers</h6><h2 class="fw-bold mb-0" id="kpiCustomers">0</h2></div></div></div>
          <div class="col-12 col-sm-6 col-lg-3" id="kpiServicesWrap" style="display:none"><div class="card card-shadow"><div class="card-body"><h6 class="text-secondary text-uppercase mb-1">Services</h6><h2 class="fw-bold mb-0" id="kpiServices">0</h2></div></div></div>
          <div class="col-12 col-sm-6 col-lg-3"><div class="card card-shadow"><div class="card-body"><h6 class="text-secondary text-uppercase mb-1">Projects</h6><h2 class="fw-bold mb-0" id="kpiProjects">0</h2></div></div></div>
          <div class="col-12 col-sm-6 col-lg-3"><div class="card card-shadow"><div class="card-body"><h6 class="text-secondary text-uppercase mb-1">Opportunities</h6><h2 class="fw-bold mb-0" id="kpiOpportunities">0</h2></div></div></div>
        </div>
        <div class="row g-4 mt-2">
          <div class="col-12 col-lg-6"><div class="card card-shadow"><div class="card-body"><h6 class="text-secondary text-uppercase mb-1">Total Opportunity Value</h6><h2 class="fw-bold mb-0" id="kpiOppValue">0 đ</h2></div></div></div>
        </div>
      </section>

      <!-- CUSTOMERS -->
      <section id="page-customers" class="section-anchor d-none">
        <div class="d-flex align-items-center mb-4">
          <h1 class="h3 mb-0"><i class="bi bi-people me-2"></i>Customers</h1>
          <div class="ms-auto"><button class="btn btn-primary" id="btnAddCustomer"><i class="bi bi-plus-lg me-1"></i>Thêm khách hàng</button></div>
        </div>
        <div id="customerFormWrap" class="d-none"></div>
        <div class="card card-shadow"><div class="card-body table-responsive">
          <table class="table table-hover table-sm align-middle">
            <thead class="table-light"><tr><th>ID</th><th>Tên</th><th>Người liên hệ</th><th>Điện thoại</th><th>Email</th><th>Mã số thuế</th><th style="width:140px;">Actions</th></tr></thead>
            <tbody id="customerTbody"></tbody>
          </table>
        </div></div>
      </section>

      <!-- PROJECTS -->
      <section id="page-projects" class="section-anchor d-none">
        <div class="d-flex align-items-center mb-4">
          <h1 class="h3 mb-0"><i class="bi bi-kanban me-2"></i>Projects</h1>
          <div class="ms-auto"><button class="btn btn-primary" id="btnAddProject"><i class="bi bi-plus-lg me-1"></i>Thêm dự án</button></div>
        </div>
        <div id="projectFormWrap" class="d-none"></div>
        <div class="card card-shadow"><div class="card-body table-responsive">
          <table class="table table-hover table-sm align-middle">
            <thead class="table-light"><tr><th>ID</th><th>Tên dự án</th><th>Khách hàng</th><th>Ngày bắt đầu</th><th>Ngày kết thúc</th><th>Status</th><th style="width:140px;">Actions</th></tr></thead>
            <tbody id="projectTbody"></tbody>
          </table>
        </div></div>
      </section>

      <!-- OPPORTUNITIES -->
      <section id="page-opportunities" class="section-anchor d-none">
        <div class="d-flex align-items-center mb-4">
          <h1 class="h3 mb-0"><i class="bi bi-bullseye me-2"></i>Opportunities</h1>
          <div class="ms-auto"><button class="btn btn-primary" id="btnAddOpportunity"><i class="bi bi-plus-lg me-1"></i>Thêm cơ hội</button></div>
        </div>
        <div id="oppFormWrap" class="d-none"></div>
        <div class="card card-shadow"><div class="card-body table-responsive">
          <table class="table table-hover table-sm align-middle">
            <thead class="table-light"><tr><th>ID</th><th>Tên cơ hội</th><th>Khách hàng</th><th>Giá trị</th><th>Stage</th><th style="width:120px;">Actions</th></tr></thead>
            <tbody id="oppTbody"></tbody>
          </table>
        </div></div>
      </section>

      <!-- QUOTES (SIMPLIFIED) -->
      <section id="page-quotes" class="section-anchor d-none">
        <div class="d-flex align-items-center mb-4">
          <h1 class="h3 mb-0"><i class="bi bi-receipt me-2"></i>Quotes</h1>
          <div class="ms-auto"><button class="btn btn-primary" id="btnAddQuote"><i class="bi bi-plus-lg me-1"></i>Thêm báo giá</button></div>
        </div>
        <div id="quoteFormWrap" class="d-none"></div>
        <div class="card card-shadow"><div class="card-body table-responsive">
          <table class="table table-hover table-sm align-middle">
            <thead class="table-light">
              <tr>
                <th>ID</th>
                <th>Khách hàng</th>
                <th>Dự án</th>
                <th class="text-start">Nội dung</th>
                <th>Số tiền</th>
                <th>Status</th>
                <th>Lần gửi</th>
                <th>Ngày gửi</th>
                <th>PDF</th>
                <th style="width:140px;">Actions</th>
              </tr>
            </thead>
            <tbody id="quoteTbody"></tbody>
          </table>
        </div></div>
      </section>

      <!-- CONTRACTS -->
      <section id="page-contracts" class="section-anchor d-none">
        <div class="d-flex align-items-center mb-4">
          <h1 class="h3 mb-0"><i class="bi bi-file-earmark-text me-2"></i>Contracts</h1>
          <div class="ms-auto"><button class="btn btn-primary" id="btnAddContract"><i class="bi bi-plus-lg me-1"></i>Thêm hợp đồng</button></div>
        </div>
        <div id="contractFormWrap" class="d-none"></div>
        <div class="card card-shadow"><div class="card-body table-responsive">
          <table class="table table-hover table-sm align-middle">
            <thead class="table-light"><tr><th>ID</th><th>Dự án</th><th>Khách hàng</th><th>Giá trị</th><th>Status</th><th style="width:140px;">Actions</th></tr></thead>
            <tbody id="contractTbody"></tbody>
          </table>
        </div></div>
      </section>

      <!-- USERS -->
      <section id="page-users" class="section-anchor d-none">
        <div class="d-flex align-items-center mb-4">
          <h1 class="h3 mb-0"><i class="bi bi-person-gear me-2"></i>Users</h1>
          <div class="ms-auto"><button class="btn btn-primary" id="btnAddUser"><i class="bi bi-plus-lg me-1"></i>Thêm user</button></div>
        </div>
        <div id="userFormWrap" class="d-none"></div>
        <div class="card card-shadow"><div class="card-body table-responsive">
          <table class="table table-hover table-sm align-middle">
            <thead class="table-light"><tr><th>Email</th><th>Role</th><th>Active</th><th style="width:140px;">Actions</th></tr></thead>
            <tbody id="userTbody"></tbody>
          </table>
        </div></div>
      </section>

    </div>
  </main>

  <!-- ========================= SCRIPTS ========================= -->
  <script>
    /* 0) SUPABASE CONFIG */
    const SUPABASE_URL = 'https://sdmjdhmkjyadgyfodpsf.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNkbWpkaG1ranlhZGd5Zm9kcHNmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM2ODQyNjIsImV4cCI6MjA2OTI2MDI2Mn0.Org3PD8CNmqCxC8ylbNiPA5Guo0w0srXgxyF2s2ZHG0';
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /* 1) STATE */
    let currentUser = { email: null, role: 'user' };
    let customers = [], services = [], projects = [], opportunities = [], quotes = [], contracts = [], users = [];

    /* Helpers */
    const pad = (n,w)=> (n+'').padStart(w,'0');
    function getWeekNumber(date=new Date()){ const d=new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate())); const dayNum=d.getUTCDay()||7; d.setUTCDate(d.getUTCDate()+4-dayNum); const yearStart=new Date(Date.UTC(d.getUTCFullYear(),0,1)); return Math.ceil((((d-yearStart)/86400000)+1)/7); }
    function money(n){ return (n||0).toLocaleString('vi-VN'); }

    // Format number with thousand separators for input fields
    function formatMoney(input) {
      let value = input.value.replace(/\./g, '');
      if (value && !isNaN(value)) {
        input.value = parseInt(value).toLocaleString('vi-VN');
      }
    }

    // Parse money string back to number
    function parseMoney(str) {
      return parseInt((str || '0').replace(/\./g, ''), 10) || 0;
    }

    function generateCustomerId(){ const used=customers.map(c=>parseInt((c.id||'').slice(1),10)).filter(Number.isFinite); for(let i=1;i<10000;i++) if(!used.includes(i)) return 'C'+pad(i,4); throw new Error('Hết mã khách hàng'); }
    function generateProjectId(){ const y=new Date().getFullYear().toString().slice(-2); const used=projects.filter(p=>(p.project_id||'').startsWith('P_'+y)).map(p=>parseInt(p.project_id.slice(4),10)).filter(Number.isFinite); for(let i=1;i<1000;i++) if(!used.includes(i)) return 'P_'+y+pad(i,3); throw new Error('Hết mã dự án'); }
    function generateOpportunityId(){ const used=opportunities.map(o=>parseInt((o.opportunity_id||'').split('_')[1],10)).filter(Number.isFinite); for(let i=1;i<100000;i++) if(!used.includes(i)) return 'Op_'+pad(i,5); throw new Error('Hết mã cơ hội'); }
    function generateQuoteId(){ const now=new Date(); const y=now.getFullYear().toString().slice(-2); const w=pad(getWeekNumber(now),2); const used=quotes.filter(q=>(q.quotes_id||'').startsWith(`Q_${y}${w}`)).map(q=>parseInt(q.quotes_id.slice(6),10)).filter(Number.isFinite); for(let i=1;i<=99;i++) if(!used.includes(i)) return `Q_${y}${w}${pad(i,2)}`; throw new Error('Hết mã báo giá'); }
    function generateContractId(){ const now=new Date(); const y=now.getFullYear().toString().slice(-2); const w=pad(getWeekNumber(now),2); const used=contracts.filter(c=>(c.contract_id||'').startsWith(`HD_${y}${w}`)).map(c=>parseInt(c.contract_id.slice(7),10)).filter(Number.isFinite); for(let i=1;i<=99;i++) if(!used.includes(i)) return `HD_${y}${w}${pad(i,2)}`; throw new Error('Hết mã hợp đồng'); }

    // Local storage for restricting Customers visibility for normal users
    function getMyCustomerIds(){ try{ const map = JSON.parse(localStorage.getItem('myCustomers')||'{}'); return map[currentUser.email] || []; }catch{ return []; } }
    function pushMyCustomerId(id){ try{ const map = JSON.parse(localStorage.getItem('myCustomers')||'{}'); map[currentUser.email] = map[currentUser.email] || []; if(!map[currentUser.email].includes(id)) map[currentUser.email].push(id); localStorage.setItem('myCustomers', JSON.stringify(map)); }catch{} }

    function showSection(page){ document.querySelectorAll('[id^="page-"]').forEach(el=>el.classList.add('d-none')); document.getElementById(`page-${page}`).classList.remove('d-none'); document.querySelectorAll('.sidebar .nav-link').forEach(a=>{ if(a.dataset.page===page) a.classList.add('active'); else a.classList.remove('active'); }); }
    function setKPIs(){ document.getElementById('kpiCustomers').textContent = customers.length; const sw=document.getElementById('kpiServicesWrap'); if(sw) sw.style.display='none'; document.getElementById('kpiProjects').textContent = projects.length; document.getElementById('kpiOpportunities').textContent = opportunities.length; const totalVal = opportunities.reduce((s,o)=>s+(o.expected_value||0),0); document.getElementById('kpiOppValue').textContent = money(totalVal) + ' đ'; }
    document.addEventListener('click',(e)=>{ if(!e.target.closest('.suggestions') && !e.target.closest('input')) document.querySelectorAll('.suggestions').forEach(b=>b.classList.add('d-none')); });

    /* 3) LOAD DATA */
    async function loadAll(){ const rs = await Promise.all([
        sb.from('customers').select('*').order('id'),
        // services disabled
        sb.from('projects').select('*').order('project_id'),
        sb.from('opportunities').select('*').order('opportunity_id'),
        sb.from('quotes').select('*').order('quotes_id'),
        sb.from('contracts').select('*').order('contract_id'),
        sb.from('user_profiles').select('*')
      ]);
      customers = rs[0].data || [];
      services = []; // disabled
      projects = rs[1].data || [];
      opportunities = rs[2].data || [];
      quotes = rs[3].data || [];
      contracts = rs[4].data || [];
      users = rs[5].data || [];
    }

    /* 4) RENDERERS */
    function renderDashboard(){ setKPIs(); }

    function renderCustomers(){ const tbody=document.getElementById('customerTbody'); let list = customers; const elevated = ['admin','BOM'].includes(currentUser.role); if(!elevated){ const ids=getMyCustomerIds(); list = customers.filter(c=>ids.includes(c.id)); } tbody.innerHTML = list.map(c=>`
        <tr>
          <td>${c.id}</td>
          <td class="text-start">${c.name||''}</td>
          <td>${c.contact_person||''}</td>
          <td>${c.phone||''}</td>
          <td>${c.email||''}</td>
          <td>${c.tax_code||''}</td>
          <td>
            <button class="btn btn-sm btn-outline-secondary me-1" onclick="openCustomerForm('${c.id}')"><i class="bi bi-pencil-square"></i></button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteCustomer('${c.id}')"><i class="bi bi-trash"></i></button>
          </td>
        </tr>
      `).join(''); }

    function openCustomerForm(id=''){
      const wrap=document.getElementById('customerFormWrap'); const isEdit=!!id; const c=isEdit?customers.find(x=>x.id===id):{}; wrap.classList.remove('d-none'); wrap.scrollIntoView({ behavior: 'smooth', block: 'start' });wrap.innerHTML=`
        <div class="card card-shadow mb-4"><div class="card-body">
          <h5 class="card-title mb-3">${isEdit?'Sửa':'Thêm'} khách hàng</h5>
          <div class="row g-3">
            <div class="col-md-2"><label class="form-label">ID</label><input class="form-control" disabled id="c_id" value="${isEdit?c.id:generateCustomerId()}"></div>
            <div class="col-md-5"><label class="form-label">Tên công ty</label><input class="form-control" id="c_name" value="${c.name||''}"></div>
            <div class="col-md-5"><label class="form-label">Người liên hệ</label><input class="form-control" id="c_contact" value="${c.contact_person||''}"></div>
            <div class="col-md-4"><label class="form-label">Điện thoại</label><input class="form-control" id="c_phone" value="${c.phone||''}"></div>
            <div class="col-md-4"><label class="form-label">Email</label><input type="email" class="form-control" id="c_email" value="${c.email||''}"></div>
            <div class="col-md-4"><label class="form-label">Mã số thuế</label><input class="form-control" id="c_tax" value="${c.tax_code||''}"></div>
            <div class="col-12"><label class="form-label">Địa chỉ</label><textarea class="form-control" rows="2" id="c_addr">${c.address||''}</textarea></div>
          </div>
          <div class="mt-4 d-flex gap-2"><button class="btn btn-primary" onclick="${isEdit?`updateCustomer('${id}')`:'addCustomer()'}"><i class="bi bi-check2-circle me-1"></i>Lưu</button><button class="btn btn-outline-secondary" onclick="document.getElementById('customerFormWrap').classList.add('d-none')">Hủy</button></div>
        </div></div>`; }

    async function addCustomer(){
      const payload = {
        id: document.getElementById('c_id').value,
        name: document.getElementById('c_name').value.trim(),
        contact_person: document.getElementById('c_contact').value.trim(),
        phone: document.getElementById('c_phone').value.trim(),
        email: document.getElementById('c_email').value.trim(),
        tax_code: document.getElementById('c_tax').value.trim(),
        address: document.getElementById('c_addr').value.trim(),
        created_at: new Date().toISOString()
      };
      if(!payload.name) return alert('Tên công ty không được trống');
      const { error } = await sb.from('customers').insert([ payload ]);
      if(error) return alert(error.message);
      pushMyCustomerId(payload.id);
      await loadAll(); renderCustomers(); renderDashboard();
      document.getElementById('customerFormWrap').classList.add('d-none');
    }

    async function updateCustomer(id){
      const payload = {
        name: document.getElementById('c_name').value.trim(),
        contact_person: document.getElementById('c_contact').value.trim(),
        phone: document.getElementById('c_phone').value.trim(),
        email: document.getElementById('c_email').value.trim(),
        tax_code: document.getElementById('c_tax').value.trim(),
        address: document.getElementById('c_addr').value.trim()
      };
      if(!payload.name) return alert('Tên công ty không được trống');
      const { error } = await sb.from('customers').update(payload).eq('id', id);
      if(error) return alert(error.message);
      await loadAll(); renderCustomers(); renderDashboard();
      document.getElementById('customerFormWrap').classList.add('d-none');
    }

    async function deleteCustomer(id){ if(!confirm('Xóa khách hàng?')) return; const {error}=await sb.from('customers').delete().eq('id',id); if(error) return alert(error.message); await loadAll(); renderCustomers(); renderDashboard(); }

    function renderProjects(){ const tbody=document.getElementById('projectTbody'); tbody.innerHTML = projects.map(p=>{ const c=customers.find(x=>x.id===p.customer_id); return `
        <tr>
          <td>${p.project_id}</td>
          <td class="text-start">${p.name||''}</td>
          <td>${c?.name||''}</td>
          <td>${p.start_date||''}</td>
          <td>${p.end_date||''}</td>
          <td><span class="badge bg-${p.status==='completed'?'success':p.status==='in-progress'?'primary':'secondary'}">${p.status||'pending'}</span></td>
          <td>
            <button class="btn btn-sm btn-outline-secondary me-1" onclick="openProjectForm('${p.project_id}')"><i class="bi bi-pencil-square"></i></button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteProject('${p.project_id}')"><i class="bi bi-trash"></i></button>
          </td>
        </tr>
      `; }).join(''); }

    function openProjectForm(id=''){
      const wrap=document.getElementById('projectFormWrap'); const isEdit=!!id; const p=isEdit?projects.find(x=>x.project_id===id):{}; const cust=customers.find(c=>c.id===p?.customer_id); wrap.classList.remove('d-none'); wrap.scrollIntoView({ behavior: 'smooth', block: 'start' });wrap.innerHTML=`
        <div class="card card-shadow mb-4"><div class="card-body">
          <h5 class="card-title mb-3">${isEdit?'Sửa':'Thêm'} dự án</h5>
          <div class="row g-3">
            <div class="col-md-3"><label class="form-label">ID</label><input class="form-control" disabled id="p_id" value="${isEdit?p.project_id:generateProjectId()}"></div>
            <div class="col-md-9 position-relative"><label class="form-label">Khách hàng</label><input class="form-control" id="p_client" autocomplete="off" value="${cust?.name||''}" oninput="suggestCustomer(this.value,'p_client')"><div id="p_client_sugs" class="suggestions d-none"></div><input type="hidden" id="p_client_id" value="${p?.customer_id||''}"></div>
            <div class="col-12"><label class="form-label">Tên dự án</label><input class="form-control" id="p_name" value="${p?.name||''}"></div>
            <div class="col-md-6"><label class="form-label">Ngày bắt đầu</label><input type="date" class="form-control" id="p_start" value="${p?.start_date||''}"></div>
            <div class="col-md-6"><label class="form-label">Ngày kết thúc</label><input type="date" class="form-control" id="p_end" value="${p?.end_date||''}"></div>
            <div class="col-md-6"><label class="form-label">Status</label><select class="form-select" id="p_status"><option${p?.status==='pending'?' selected':''}>pending</option><option${p?.status==='in-progress'?' selected':''}>in-progress</option><option${p?.status==='completed'?' selected':''}>completed</option><option${p?.status==='cancelled'?' selected':''}>cancelled</option></select></div>
            <div class="col-12"><label class="form-label">Mô tả</label><textarea class="form-control" rows="3" id="p_desc">${p?.description||''}</textarea></div>
          </div>
          <div class="mt-4 d-flex gap-2"><button class="btn btn-primary" onclick="${isEdit?`updateProject('${id}')`:'addProject()'}"><i class="bi bi-check2-circle me-1"></i>Lưu</button><button class="btn btn-outline-secondary" onclick="document.getElementById('projectFormWrap').classList.add('d-none')">Hủy</button></div>
        </div></div>`; }

    async function addProject(){
      const payload = {
        project_id: document.getElementById('p_id').value,
        name: document.getElementById('p_name').value.trim(),
        customer_id: document.getElementById('p_client_id').value,
        start_date: document.getElementById('p_start').value,
        end_date: document.getElementById('p_end').value,
        status: document.getElementById('p_status').value,
        description: document.getElementById('p_desc').value.trim(),
        created_at: new Date().toISOString()
      };
      if(!payload.name) return alert('Tên dự án không được trống');
      if(!payload.customer_id) return alert('Chưa chọn khách hàng hợp lệ');
      const { error } = await sb.from('projects').insert([ payload ]);
      if(error) return alert(error.message);
      await loadAll(); renderProjects(); renderDashboard();
      document.getElementById('projectFormWrap').classList.add('d-none');
    }

    async function updateProject(id){
      const payload = {
        name: document.getElementById('p_name').value.trim(),
        customer_id: document.getElementById('p_client_id').value,
        start_date: document.getElementById('p_start').value,
        end_date: document.getElementById('p_end').value,
        status: document.getElementById('p_status').value,
        description: document.getElementById('p_desc').value.trim()
      };
      if(!payload.name) return alert('Tên dự án không được trống');
      if(!payload.customer_id) return alert('Chưa chọn khách hàng hợp lệ');
      const { error } = await sb.from('projects').update(payload).eq('project_id', id);
      if(error) return alert(error.message);
      await loadAll(); renderProjects(); renderDashboard();
      document.getElementById('projectFormWrap').classList.add('d-none');
    }

    async function deleteProject(id){ if(!confirm('Xóa dự án?')) return; const {error}=await sb.from('projects').delete().eq('project_id',id); if(error) return alert(error.message); await loadAll(); renderProjects(); renderDashboard(); }

    function renderOpportunities(){ const tbody=document.getElementById('oppTbody'); tbody.innerHTML = opportunities.map(o=>{ const c=customers.find(x=>x.id===o.customer_id); return `
        <tr>
          <td>${o.opportunity_id}</td>
          <td class="text-start">${o.name||''}</td>
          <td>${c?.name||''}</td>
          <td>${money(o.expected_value||0)} đ</td>
          <td><span class="badge bg-${o.stage==='won'?'success':o.stage==='lost'?'danger':'primary'}">${o.stage||'lead'}</span></td>
          <td>
            <button class="btn btn-sm btn-outline-secondary me-1" onclick="openOppForm('${o.opportunity_id}')"><i class="bi bi-pencil-square"></i></button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteOpportunity('${o.opportunity_id}')"><i class="bi bi-trash"></i></button>
          </td>
        </tr>
      `; }).join(''); }

    function openOppForm(id=''){
      const wrap=document.getElementById('oppFormWrap'); const isEdit=!!id; const o=isEdit?opportunities.find(x=>x.opportunity_id===id):{}; const cust=customers.find(c=>c.id===o?.customer_id); wrap.classList.remove('d-none'); wrap.scrollIntoView({ behavior: 'smooth', block: 'start' });wrap.innerHTML=`
        <div class="card card-shadow mb-4"><div class="card-body">
          <h5 class="card-title mb-3">${isEdit?'Sửa':'Thêm'} cơ hội</h5>
          <div class="row g-3">
            <div class="col-md-3"><label class="form-label">ID</label><input class="form-control" disabled id="op_id" value="${isEdit?o.opportunity_id:generateOpportunityId()}"></div>
            <div class="col-md-9 position-relative"><label class="form-label">Khách hàng</label><input class="form-control" id="op_client" autocomplete="off" value="${cust?.name||''}" oninput="suggestCustomer(this.value,'op_client')"><div id="op_client_sugs" class="suggestions d-none"></div><input type="hidden" id="op_client_id" value="${o?.customer_id||''}"></div>
            <div class="col-md-6"><label class="form-label">Tên cơ hội</label><input class="form-control" id="op_name" value="${o?.name||''}"></div>
            <div class="col-md-6"><label class="form-label">Giá trị dự kiến</label><input type="text" class="form-control money" id="op_val" value="${o?.expected_value ? money(o.expected_value) : '0'}" oninput="formatMoney(this)"></div>
            <div class="col-md-6"><label class="form-label">Stage</label><select class="form-select" id="op_stage"><option${o?.stage==='lead'?' selected':''}>lead</option><option${o?.stage==='qualified'?' selected':''}>qualified</option><option${o?.stage==='proposal'?' selected':''}>proposal</option><option${o?.stage==='negotiation'?' selected':''}>negotiation</option><option${o?.stage==='won'?' selected':''}>won</option><option${o?.stage==='lost'?' selected':''}>lost</option></select></div>
            <div class="col-12"><label class="form-label">Mô tả</label><textarea class="form-control" rows="2" id="op_desc">${o?.description||''}</textarea></div>
          </div>
          <div class="mt-4 d-flex gap-2"><button class="btn btn-primary" onclick="${isEdit?`updateOpportunity('${id}')`:'addOpportunity()'}"><i class="bi bi-check2-circle me-1"></i>Lưu</button><button class="btn btn-outline-secondary" onclick="document.getElementById('oppFormWrap').classList.add('d-none')">Hủy</button></div>
        </div></div>`; }

    async function addOpportunity(){
      // Lấy raw value và strip dấu phân tách
      const rawVal = document.getElementById('op_val').value.replace(/\./g,'') || '0';

      const payload = {
        opportunity_id: document.getElementById('op_id').value,
        name:           document.getElementById('op_name').value.trim(),
        customer_id:    document.getElementById('op_client_id').value,
        expected_value: parseInt(rawVal, 10),
        stage:          document.getElementById('op_stage').value,
        created_at:     new Date().toISOString()
      };

      // Các kiểm tra bắt buộc
      if(!payload.name)        return alert('Tên cơ hội không được trống');
      if(!payload.customer_id) return alert('Chưa chọn khách hàng hợp lệ');

      // Thực hiện INSERT
      const { error } = await sb
        .from('opportunities')
        .insert([ payload ]);

      if(error) return alert(error.message);

      // Làm mới dữ liệu & UI
      await loadAll();
      renderOpportunities();
      renderDashboard();
      document.getElementById('oppFormWrap').classList.add('d-none');
    }

    async function updateOpportunity(id){
      // Lấy raw value và strip dấu phân tách
      const rawVal = document.getElementById('op_val').value.replace(/\./g,'') || '0';

      const payload = {
        name:           document.getElementById('op_name').value.trim(),
        customer_id:    document.getElementById('op_client_id').value,
        expected_value: parseInt(rawVal, 10),
        stage:          document.getElementById('op_stage').value
      };

      // Các kiểm tra bắt buộc
      if(!payload.name)        return alert('Tên cơ hội không được trống');
      if(!payload.customer_id) return alert('Chưa chọn khách hàng hợp lệ');

      // Thực hiện UPDATE
      const { error } = await sb
        .from('opportunities')
        .update(payload)
        .eq('opportunity_id', id);

      if(error) return alert(error.message);

      // Làm mới dữ liệu & UI
      await loadAll();
      renderOpportunities();
      renderDashboard();
      document.getElementById('oppFormWrap').classList.add('d-none');
    }

    async function deleteOpportunity(id){ if(!confirm('Xóa cơ hội?')) return; const {error}=await sb.from('opportunities').delete().eq('opportunity_id',id); if(error) return alert(error.message); await loadAll(); renderOpportunities(); renderDashboard(); }

    /* QUOTES (SIMPLIFIED) */
    function renderQuotes(){ const tbody=document.getElementById('quoteTbody'); tbody.innerHTML = quotes.map(q=>{ const c=customers.find(x=>x.id===q.customer_id); const pr=projects.find(p=>p.project_id===q.project_id); return `
        <tr>
          <td>${q.quotes_id}</td>
          <td>${c?.name||''}</td>
          <td>${pr?.name||''}</td>
          <td class="text-start">${q.description||''}</td>
          <td>${money(q.amount||0)} đ</td>
          <td><span class="badge bg-${q.status==='chấp nhận'?'success':q.status==='từ chối'?'danger':q.status==='đã gửi'?'primary':'secondary'}">${q.status||'nháp'}</span></td>
          <td>${q.send_count||0}</td>
          <td>${q.send_date||''}</td>
          <td>${q.pdf_url?`<a href="${q.pdf_url}" target="_blank" class="btn btn-sm btn-outline-primary"><i class="bi bi-file-pdf"></i></a>`:''}</td>
          <td>
            <button class="btn btn-sm btn-outline-secondary me-1" onclick="openQuoteForm('${q.quotes_id}')"><i class="bi bi-pencil-square"></i></button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteQuote('${q.quotes_id}')"><i class="bi bi-trash"></i></button>
          </td>
        </tr>
      `; }).join(''); }

    function openQuoteForm(id=''){ const wrap=document.getElementById('quoteFormWrap'); const isEdit=!!id; const q=isEdit?quotes.find(x=>x.quotes_id===id):{}; const cust=customers.find(c=>c.id===q?.customer_id); const pr=projects.find(p=>p.project_id===q?.project_id); wrap.classList.remove('d-none'); window.scrollTo({ top: 0, behavior: 'smooth' });wrap.innerHTML=`
        <div class="card card-shadow mb-4"><div class="card-body">
          <h5 class="card-title mb-3">${isEdit?'Sửa':'Thêm'} báo giá</h5>
          <div class="row g-3">
            <div class="col-md-3"><label class="form-label">ID</label><input class="form-control" disabled id="q_id" value="${isEdit?q.quotes_id:generateQuoteId()}"></div>
            <div class="col-md-9 position-relative"><label class="form-label">Khách hàng</label><input class="form-control" id="q_client" autocomplete="off" value="${cust?.name||''}" oninput="suggestCustomer(this.value,'q_client')"><div id="q_client_sugs" class="suggestions d-none"></div><input type="hidden" id="q_client_id" value="${q?.customer_id||''}"></div>
            <div class="col-md-6 position-relative"><label class="form-label">Dự án</label><input class="form-control" id="q_project" oninput="suggestProject(this.value,'q_project')" value="${pr?.name||''}">
<div id="q_project_sugs" class="suggestions d-none"></div><input type="hidden" id="q_project_id" value="${q?.project_id||''}"></div>
            <div class="col-md-6"><label class="form-label">Số tiền</label><input type="text" class="form-control money" id="q_amount"
       value="${q?.amount ? money(q.amount) : '0'}" oninput="formatMoney(this)"></div>
            <div class="col-12"><label class="form-label">Nội dung</label><textarea class="form-control" rows="2" id="q_desc">${q?.description||''}</textarea></div>
            <div class="col-md-4"><label class="form-label">Status</label><select class="form-select" id="q_status"><option${q?.status==='nháp'?' selected':''}>nháp</option><option${q?.status==='đã gửi'?' selected':''}>đã gửi</option><option${q?.status==='chấp nhận'?' selected':''}>chấp nhận</option><option${q?.status==='từ chối'?' selected':''}>từ chối</option></select></div>
            <div class="col-md-2"><label class="form-label">Lần gửi</label><input type="number" class="form-control" id="q_send" value="${q?.send_count||0}"></div>
            <div class="col-md-3"><label class="form-label">Ngày gửi</label><input type="date" class="form-control" id="q_send_date" value="${q?.send_date||''}"></div>
            <div class="col-md-3"><label class="form-label">PDF URL</label><input class="form-control" id="q_pdf" placeholder="https://...pdf" value="${q?.pdf_url||''}"></div>
          </div>
          <div class="mt-4 d-flex gap-2"><button class="btn btn-primary" onclick="${isEdit?`updateQuote('${id}')`:'addQuote()}"><i class="bi bi-check2-circle me-1"></i>Lưu báo giá</button><button class="btn btn-outline-secondary" onclick="document.getElementById('quoteFormWrap').classList.add('d-none')">Hủy</button></div>
        </div></div>`; }

    // ADD QUOTE FUNCTION (MISSING)
    async function addQuote(){
      // Lấy raw value và strip dấu phân tách
      const rawVal = document.getElementById('q_amount').value.replace(/\./g,'') || '0';

      const payload = {
        quotes_id: document.getElementById('q_id').value,
        customer_id: document.getElementById('q_client_id').value,
        project_id: document.getElementById('q_project_id').value,
        description: document.getElementById('q_desc').value.trim(),
        amount: parseInt(rawVal, 10),
        status: document.getElementById('q_status').value,
        send_count: parseInt(document.getElementById('q_send').value, 10) || 0,
        send_date: document.getElementById('q_send_date').value || null,
        pdf_url: document.getElementById('q_pdf').value.trim() || null,
        created_at: new Date().toISOString()
      };

      // Các kiểm tra bắt buộc
      if(!payload.customer_id) return alert('Chưa chọn khách hàng hợp lệ');
      if(!payload.description) return alert('Nội dung báo giá không được trống');

      // Thực hiện INSERT
      const { error } = await sb
        .from('quotes')
        .insert([ payload ]);

      if(error) return alert(error.message);

      // Làm mới dữ liệu & UI
      await loadAll();
      renderQuotes();
      renderDashboard();
      document.getElementById('quoteFormWrap').classList.add('d-none');
    }

    // UPDATE QUOTE FUNCTION (MISSING)
    async function updateQuote(id){
      // Lấy raw value và strip dấu phân tách
      const rawVal = document.getElementById('q_amount').value.replace(/\./g,'') || '0';

      const payload = {
        customer_id: document.getElementById('q_client_id').value,
        project_id: document.getElementById('q_project_id').value,
        description: document.getElementById('q_desc').value.trim(),
        amount: parseInt(rawVal, 10),
        status: document.getElementById('q_status').value,
        send_count: parseInt(document.getElementById('q_send').value, 10) || 0,
        send_date: document.getElementById('q_send_date').value || null,
        pdf_url: document.getElementById('q_pdf').value.trim() || null
      };

      // Các kiểm tra bắt buộc
      if(!payload.customer_id) return alert('Chưa chọn khách hàng hợp lệ');
      if(!payload.description) return alert('Nội dung báo giá không được trống');

      // Thực hiện UPDATE
      const { error } = await sb
        .from('quotes')
        .update(payload)
        .eq('quotes_id', id);

      if(error) return alert(error.message);

      // Làm mới dữ liệu & UI
      await loadAll();
      renderQuotes();
      renderDashboard();
      document.getElementById('quoteFormWrap').classList.add('d-none');
    }

    async function deleteQuote(id){ if(!confirm('Xóa báo giá?')) return; const {error}=await sb.from('quotes').delete().eq('quotes_id',id); if(error) return alert(error.message); await loadAll(); renderQuotes(); renderDashboard(); }

    /* CONTRACTS */
    function renderContracts(){ const tbody=document.getElementById('contractTbody'); tbody.innerHTML = contracts.map(ct=>{ const pr=projects.find(p=>p.project_id===ct.project_id); const c=customers.find(x=>x.id===ct.customer_id); return `
        <tr>
          <td>${ct.contract_id}</td>
          <td>${pr?.name||''}</td>
          <td>${c?.name||''}</td>
          <td>${money(ct.value||0)} đ</td>
          <td><span class="badge bg-${ct.status==='signed'?'success':ct.status==='pending'?'warning':'secondary'}">${ct.status||'draft'}</span></td>
          <td>
            <button class="btn btn-sm btn-outline-secondary me-1" onclick="openContractForm('${ct.contract_id}')"><i class="bi bi-pencil-square"></i></button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteContract('${ct.contract_id}')"><i class="bi bi-trash"></i></button>
          </td>
        </tr>
      `; }).join(''); }

    function openContractForm(id=''){
      const wrap=document.getElementById('contractFormWrap'); const isEdit=!!id; const ct=isEdit?contracts.find(x=>x.contract_id===id):{}; const cust=customers.find(c=>c.id===ct?.customer_id); const pr=projects.find(p=>p.project_id===ct?.project_id); const qt=quotes.find(q=>q.quotes_id===ct?.quotes_id); wrap.classList.remove('d-none'); wrap.scrollIntoView({ behavior: 'smooth', block: 'start' });wrap.innerHTML=`
        <div class="card card-shadow mb-4"><div class="card-body">
          <h5 class="card-title mb-3">${isEdit?'Sửa':'Thêm'} hợp đồng</h5>
          <div class="row g-3">
            <div class="col-md-3"><label class="form-label">ID</label><input class="form-control" disabled id="ct_id" value="${isEdit?ct.contract_id:generateContractId()}"></div>
            <div class="col-md-9 position-relative"><label class="form-label">Khách hàng</label><input class="form-control" id="ct_client" autocomplete="off" value="${cust?.name||''}" oninput="suggestCustomer(this.value,'ct_client')"><div id="ct_client_sugs" class="suggestions d-none"></div><input type="hidden" id="ct_client_id" value="${ct?.customer_id||''}"></div>
            <div class="col-md-6 position-relative"><label class="form-label">Dự án</label><input class="form-control" id="ct_project" oninput="suggestProject(this.value,'ct_project')" value="${pr?.name||''}"><div id="ct_project_sugs" class="suggestions d-none"></div><input type="hidden" id="ct_project_id" value="${ct?.project_id||''}"></div>
            <div class="col-md-6 position-relative"><label class="form-label">Báo giá</label><input class="form-control" id="ct_quote" oninput="suggestQuote(this.value,'ct_quote')" 
                 value="${ct?.quotes_id||''}"><div id="ct_quote_sugs" class="suggestions d-none"></div>
          <input type="hidden" id="ct_quote_id" value="${ct?.quotes_id||''}"></div>
            <div class="col-md-6"><label class="form-label">Giá trị</label><input type="text" class="form-control money" id="ct_value" value="${ct?.value ? money(ct.value) : '0'}" oninput="formatMoney(this)"></div>
            <div class="col-md-6"><label class="form-label">Status</label><select class="form-select" id="ct_status"><option${ct?.status==='draft'?' selected':''}>draft</option><option${ct?.status==='pending'?' selected':''}>pending</option><option${ct?.status==='signed'?' selected':''}>signed</option><option${ct?.status==='cancelled'?' selected':''}>cancelled</option></select></div>
            <div class="col-md-6"><label class="form-label">Ngày ký</label><input type="date" class="form-control" id="ct_signed" value="${ct?.signed_date||''}"></div>
            <div class="col-12"><label class="form-label">Ghi chú</label><textarea class="form-control" rows="2" id="ct_notes">${ct?.notes||''}</textarea></div>
          </div>
          <div class="mt-4 d-flex gap-2"><button class="btn btn-primary" onclick="${isEdit?`updateContract('${id}')`:'addContract()'}"><i class="bi bi-check2-circle me-1"></i>Lưu</button><button class="btn btn-outline-secondary" onclick="document.getElementById('contractFormWrap').classList.add('d-none')">Hủy</button></div>
        </div></div>`; }

    async function addContract(){
      // Lấy raw value và strip dấu phân tách
      const rawVal = document.getElementById('ct_value').value.replace(/\./g,'') || '0';

      const payload = {
        contract_id: document.getElementById('ct_id').value,
        customer_id: document.getElementById('ct_client_id').value,
        project_id: document.getElementById('ct_project_id').value,
        quotes_id:     document.getElementById('ct_quote_id').value || null,
        value: parseInt(rawVal, 10),
        status: document.getElementById('ct_status').value,
        signed_date: document.getElementById('ct_signed').value || null,
        notes: document.getElementById('ct_notes').value.trim(),
        created_at: new Date().toISOString()
      };

      // Các kiểm tra bắt buộc
      if(!payload.customer_id) return alert('Chưa chọn khách hàng hợp lệ');

      // Thực hiện INSERT
      const { error } = await sb
        .from('contracts')
        .insert([ payload ]);

      if(error) return alert(error.message);

      // Làm mới dữ liệu & UI
      await loadAll();
      renderContracts();
      renderDashboard();
      document.getElementById('contractFormWrap').classList.add('d-none');
    }

    async function updateContract(id){
      // Lấy raw value và strip dấu phân tách
      const rawVal = document.getElementById('ct_value').value.replace(/\./g,'') || '0';

      const payload = {
        customer_id: document.getElementById('ct_client_id').value,
        project_id: document.getElementById('ct_project_id').value,
        quotes_id:     document.getElementById('ct_quote_id').value || null,
        value: parseInt(rawVal, 10),
        status: document.getElementById('ct_status').value,
        signed_date: document.getElementById('ct_signed').value || null,
        notes: document.getElementById('ct_notes').value.trim()
      };

      // Các kiểm tra bắt buộc
      if(!payload.customer_id) return alert('Chưa chọn khách hàng hợp lệ');

      // Thực hiện UPDATE
      const { error } = await sb
        .from('contracts')
        .update(payload)
        .eq('contract_id', id);

      if(error) return alert(error.message);

      // Làm mới dữ liệu & UI
      await loadAll();
      renderContracts();
      renderDashboard();
      document.getElementById('contractFormWrap').classList.add('d-none');
    }

    async function deleteContract(id){ if(!confirm('Xóa hợp đồng?')) return; const {error}=await sb.from('contracts').delete().eq('contract_id',id); if(error) return alert(error.message); await loadAll(); renderContracts(); renderDashboard(); }

    function renderUsers(){ const tbody=document.getElementById('userTbody'); tbody.innerHTML = users.map(u=>`
        <tr>
          <td>${u.email}</td>
          <td><span class="badge bg-${u.role==='admin'?'danger':u.role==='BOM'?'warning':'primary'}">${u.role}</span></td>
          <td><span class="badge bg-${u.active?'success':'secondary'}">${u.active?'Yes':'No'}</span></td>
          <td>
            <button class="btn btn-sm btn-outline-secondary me-1" onclick="openUserForm('${u.email}')"><i class="bi bi-pencil-square"></i></button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteUser('${u.email}')"><i class="bi bi-trash"></i></button>
          </td>
        </tr>
      `).join(''); }

    function openUserForm(email=''){
      const wrap=document.getElementById('userFormWrap'); const isEdit=!!email; const u=isEdit?users.find(x=>x.email===email):{}; wrap.classList.remove('d-none'); wrap.scrollIntoView({ behavior: 'smooth', block: 'start' });wrap.innerHTML=`
        <div class="card card-shadow mb-4"><div class="card-body">
          <h5 class="card-title mb-3">${isEdit?'Sửa':'Thêm'} user</h5>
          <div class="row g-3">
            <div class="col-md-6"><label class="form-label">Email</label><input type="email" class="form-control" id="u_email" ${isEdit?'disabled':''} value="${u.email||''}"></div>
            <div class="col-md-3"><label class="form-label">Role</label><select class="form-select" id="u_role"><option${u?.role==='user'?' selected':''}>user</option><option${u?.role==='admin'?' selected':''}>admin</option><option${u?.role==='BOM'?' selected':''}>BOM</option></select></div>
            <div class="col-md-3"><label class="form-label">Active</label><select class="form-select" id="u_active"><option value="true"${u?.active?' selected':''}>Yes</option><option value="false"${!u?.active?' selected':''}>No</option></select></div>
          </div>
          <div class="mt-4 d-flex gap-2"><button class="btn btn-primary" onclick="${isEdit?`updateUser('${email}')`:'addUser()'}"><i class="bi bi-check2-circle me-1"></i>Lưu</button><button class="btn btn-outline-secondary" onclick="document.getElementById('userFormWrap').classList.add('d-none')">Hủy</button></div>
        </div></div>`; }

    async function addUser(){
      const payload = {
        email: document.getElementById('u_email').value.trim(),
        role: document.getElementById('u_role').value,
        active: document.getElementById('u_active').value === 'true',
        created_at: new Date().toISOString()
      };
      if(!payload.email) return alert('Email không được trống');
      const { error } = await sb.from('user_profiles').insert([ payload ]);
      if(error) return alert(error.message);
      await loadAll(); renderUsers();
      document.getElementById('userFormWrap').classList.add('d-none');
    }

    async function updateUser(email){
      const payload = {
        role: document.getElementById('u_role').value,
        active: document.getElementById('u_active').value === 'true'
      };
      const { error } = await sb.from('user_profiles').update(payload).eq('email', email);
      if(error) return alert(error.message);
      await loadAll(); renderUsers();
      document.getElementById('userFormWrap').classList.add('d-none');
    }

    async function deleteUser(email){ if(!confirm('Xóa user?')) return; const {error}=await sb.from('user_profiles').delete().eq('email',email); if(error) return alert(error.message); await loadAll(); renderUsers(); }

    /* SUGGESTIONS */
    function suggestCustomer(q, fld) {
      const sugs = document.getElementById(fld + '_sugs');
      if (!q.trim()) { sugs.classList.add('d-none'); return; }
      const matches = customers.filter(c => (c.name || '').toLowerCase().includes(q.toLowerCase()));
      if (!matches.length) { sugs.classList.add('d-none'); return; }
      sugs.innerHTML = matches.slice(0, 5).map(c => `<div class="suggestion-item" onclick="selectCustomer('${c.id}','${c.name}','${fld}')">${c.name} (${c.id})</div>`).join('');
      sugs.classList.remove('d-none');
    }

    function selectCustomer(id, name, fld) {
      document.getElementById(fld).value = name;
      document.getElementById(fld + '_id').value = id;
      document.getElementById(fld + '_sugs').classList.add('d-none');
    }

    function suggestProject(q, fld) {
      const sugs = document.getElementById(fld + '_sugs');
      if (!q.trim()) { sugs.classList.add('d-none'); return; }
      const matches = projects.filter(p => (p.name || '').toLowerCase().includes(q.toLowerCase()));
      if (!matches.length) { sugs.classList.add('d-none'); return; }
      sugs.innerHTML = matches.slice(0, 5).map(p => `<div class="suggestion-item" onclick="selectProject('${p.project_id}','${p.name}','${fld}')">${p.name} (${p.project_id})</div>`).join('');
      sugs.classList.remove('d-none');
    }

    function selectProject(id, name, fld) {
      document.getElementById(fld).value = name;
      document.getElementById(fld + '_id').value = id;
      document.getElementById(fld + '_sugs').classList.add('d-none');
    }

    function suggestQuote(q, fld) {
      const sugs = document.getElementById(fld + '_sugs');
      if (!q.trim()) { sugs.classList.add('d-none'); return; }
      const matches = quotes.filter(qt => (qt.quotes_id || '').toLowerCase().includes(q.toLowerCase()));
      if (!matches.length) { sugs.classList.add('d-none'); return; }
      sugs.innerHTML = matches.slice(0, 5).map(qt => `<div class="suggestion-item" onclick="selectQuote('${qt.quotes_id}','${fld}')">${qt.quotes_id} - ${qt.description || ''}</div>`).join('');
      sugs.classList.remove('d-none');
    }

    function selectQuote(id, fld) {
      document.getElementById(fld).value = id;
      document.getElementById(fld + '_id').value = id;
      document.getElementById(fld + '_sugs').classList.add('d-none');
    }

    /* AUTH */
    async function enforceAuth() {
      const { data: { session } } = await sb.auth.getSession();
      if (!session) {
        document.getElementById('authOverlay').classList.remove('d-none');
        return;
      }
      const email = session.user.email;
      const profile = users.find(u => u.email === email && u.active);
      if (!profile) {
        document.getElementById('authError').textContent = `Email "${email}" không có quyền truy cập hoặc chưa được kích hoạt.`;
        await sb.auth.signOut();
        return;
      }
      currentUser = { email, role: profile.role };
      document.getElementById('currentEmail').textContent = email;
      document.getElementById('authOverlay').classList.add('d-none');
      
      // Role-based UI
      const elevated = ['admin', 'BOM'].includes(currentUser.role);
      document.getElementById('navUsers').style.display = elevated ? 'block' : 'none';
      
      await loadAll();
      renderAll();
    }

    function renderAll(){ renderDashboard(); renderCustomers(); /* services disabled */ renderProjects(); renderOpportunities(); renderQuotes(); renderContracts(); renderUsers(); }

    // AUTH EVENTS
    document.addEventListener('click',(e)=>{ if(e.target && e.target.id==='btnGoogle'){ sb.auth.signInWithOAuth({ provider:'google', options:{ redirectTo: window.location.href } }); } });
    sb.auth.onAuthStateChange((_event,_session)=>{ enforceAuth(); });

    // NAV INIT
    document.querySelectorAll('#sidebarNav .nav-link[data-page]').forEach(a=>{ a.addEventListener('click',()=> showSection(a.dataset.page)); });
    document.getElementById('btnAddCustomer').onclick = ()=>openCustomerForm();
    // btnAddService removed (disabled)
    document.getElementById('btnAddProject').onclick = ()=>openProjectForm();
    document.getElementById('btnAddOpportunity').onclick = ()=>openOppForm();
    document.getElementById('btnAddQuote').onclick = ()=>openQuoteForm();
    document.getElementById('btnAddContract').onclick = ()=>openContractForm();
    document.getElementById('btnAddUser').onclick = ()=>openUserForm();

    document.getElementById('btnSignOut').onclick = async (e)=>{ e.preventDefault(); await sb.auth.signOut(); location.reload(); };

    async function init(){ await enforceAuth(); }
    init();
  </script>

  <!-- Bootstrap 5 JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>

