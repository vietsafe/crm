/* ===== CRUD HANDLERS ===== */
    const handlers = {
      async saveCustomer(id) {
        const payload = {
          name: document.getElementById('cust_name').value.trim(),
          contact_person: document.getElementById('cust_contact').value || null,
          phone: document.getElementById('cust_phone').value || null,
          email: document.getElementById('cust_email').value || null,
          address: document.getElementById('cust_address').value || null,
          tax_code: document.getElementById('cust_tax').value || null
        };
        
        if (!payload.name) {
          utils.showToast('Tên khách hàng không được trống', 'error');
          return;
        }
        
        const btn = document.querySelector('#customerForm button[type="submit"]');
        const stopLoading = utils.showLoading(btn);
        
        let success;
        if (id) {
          success = await crud.update('customers', payload, 'id', id);
        } else {
          payload.id = document.getElementById('cust_id').value;
          payload.created_at = new Date().toISOString();
          // RLS: created_by sẽ t<!doctype html>
<html lang="vi">
<head>
  <!-- =========================================================
       CRM Bootstrap Full với Supabase RLS
       Cải tiến:
       - Tích hợp xác thực Supabase Auth
       - Row Level Security (RLS) support
       - Phân quyền người dùng theo created_by
       - Admin/BOM có quyền xem/sửa tất cả
       ========================================================= -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>CRM • Supabase RLS • Bootstrap Admin</title>

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
  <!-- Supabase JS v2 (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

  <style>
    :root {
      --sidebar-width: 280px;
      --primary-color: #0d6efd;
      --hover-bg: #e7f1ff;
      --border-color: #e9ecef;
      --shadow: 0 8px 24px rgba(0,0,0,.06);
    }

    * { box-sizing: border-box; }
    
    html, body { 
      height: 100%; 
      background-color: #f8f9fa; 
      font-size: 14px;
    }
    
    /* Sidebar Styles */
    .sidebar { 
      width: var(--sidebar-width); 
      min-height: 100vh; 
      position: fixed; 
      top: 0; 
      left: 0; 
      border-right: 1px solid var(--border-color); 
      background: #fff; 
      transform: translateX(-100%);
      transition: transform 0.3s ease;
      z-index: 1040;
    }
    
    .sidebar.show { transform: translateX(0); }
    
    .sidebar .nav-link { 
      border-radius: .5rem; 
      color: #334155; 
      transition: all 0.2s ease;
    }
    
    .sidebar .nav-link.active, 
    .sidebar .nav-link:hover { 
      background-color: var(--hover-bg); 
      color: var(--primary-color); 
    }
    
    /* Content Wrapper */
    .content-wrap { 
      margin-left: 0; 
      transition: margin-left 0.3s ease;
      min-height: 100vh;
    }
    
    /* Desktop Styles */
    @media (min-width: 992px) { 
      .sidebar { transform: translateX(0); }
      .content-wrap { margin-left: var(--sidebar-width); }
      .mobile-header { display: none; }
    }
    
    /* Mobile Header */
    .mobile-header {
      position: sticky;
      top: 0;
      z-index: 1030;
      background: #fff;
      border-bottom: 1px solid var(--border-color);
      padding: 0.75rem 1rem;
    }
    
    /* Card Styles */
    .card-shadow { 
      box-shadow: var(--shadow); 
      border: 1px solid #eef2f7; 
      border-radius: 1rem;
      transition: transform 0.2s ease;
    }
    
    .card-shadow:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 32px rgba(0,0,0,.08);
    }

    /* Autocomplete Styles */
    .suggestions { 
      position: absolute; 
      z-index: 1050; 
      background: #fff; 
      border: 1px solid #e5e7eb; 
      border-radius: .5rem; 
      max-height: 260px; 
      overflow-y: auto; 
      width: 100%; 
      box-shadow: 0 10px 22px rgba(0,0,0,.08);
      margin-top: 2px;
    }
    
    .suggestion-item { 
      padding: .75rem 1rem; 
      cursor: pointer;
      transition: background 0.15s ease;
    }
    
    .suggestion-item:hover,
    .suggestion-item.active { 
      background: #f5f7fb; 
    }

    /* Form Improvements */
    .form-control, .form-select {
      font-size: 14px;
      padding: 0.5rem 0.75rem;
    }
    
    .form-label {
      font-weight: 500;
      color: #475569;
      margin-bottom: 0.25rem;
    }

    /* Table Responsive */
    .table-responsive {
      border-radius: 0.5rem;
      overflow: hidden;
    }
    
    .table {
      font-size: 13px;
      margin-bottom: 0;
    }
    
    .table th {
      font-weight: 600;
      text-transform: uppercase;
      font-size: 11px;
      letter-spacing: 0.5px;
      padding: 0.75rem;
    }
    
    /* Mobile Table */
    @media (max-width: 768px) {
      .table-responsive {
        font-size: 12px;
      }
      
      .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 12px;
      }
      
      .table td {
        padding: 0.5rem;
      }
    }

    /* Loading State */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(0,0,0,.1);
      border-radius: 50%;
      border-top-color: var(--primary-color);
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Overlay */
    .overlay {
      position: fixed; 
      inset: 0; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      background: rgba(15,23,42,.55); 
      backdrop-filter: blur(2px); 
      z-index: 3000;
    }
    
    .overlay-card {
      width: min(420px, 90vw); 
      border-radius: 1rem; 
      box-shadow: 0 20px 40px rgba(0,0,0,.2);
    }
    
    /* Animations */
    .fade-in {
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Section Spacing */
    .section-anchor { 
      scroll-margin-top: 80px; 
    }
    
    /* Button Groups */
    .btn-group-sm > .btn {
      padding: 0.25rem 0.5rem;
    }
    
    /* Toast Notifications */
    .toast-container {
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 1080;
    }
    
    /* Backdrop for mobile */
    .sidebar-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      z-index: 1039;
      width: 100vw;
      height: 100vh;
      background-color: rgba(0,0,0,0.5);
      display: none;
    }
    
    .sidebar-backdrop.show {
      display: block;
    }

    /* Permission Indicator */
    .permission-badge {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 10px;
    }
  </style>
</head>
<body>

  <!-- Toast Container -->
  <div class="toast-container"></div>

  <!-- Mobile Header -->
  <div class="mobile-header d-lg-none">
    <div class="d-flex align-items-center justify-content-between">
      <button class="btn btn-sm btn-outline-secondary" id="sidebarToggle">
        <i class="bi bi-list fs-5"></i>
      </button>
      <span class="fw-bold">CRM Admin</span>
      <img src="https://ui-avatars.com/api/?name=CRM&background=0D6EFD&color=fff" alt="" width="32" height="32" class="rounded-circle">
    </div>
  </div>

  <!-- Sidebar Backdrop -->
  <div class="sidebar-backdrop" id="sidebarBackdrop"></div>

  <!-- ===== AUTH OVERLAY ===== -->
  <div id="authOverlay" class="overlay d-none">
    <div class="card overlay-card fade-in">
      <div class="card-body text-center p-4">
        <div class="mb-3"><i class="bi bi-shield-lock" style="font-size:2.5rem;"></i></div>
        <h5 class="fw-bold mb-2">Đăng nhập VSEC CRM</h5>
        <p class="text-muted small mb-4">Đăng nhập bằng Google để truy cập hệ thống CRM.</p>
        <button id="btnGoogle" class="btn btn-dark w-100 mb-2">
          <i class="bi bi-google me-2"></i>Đăng nhập với Google
        </button>
        <div id="authError" class="text-danger small mt-2"></div>
      </div>
    </div>
  </div>

  <!-- ========================= SIDEBAR ========================= -->
  <aside class="sidebar p-3" id="sidebar">
    <a class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-decoration-none">
      <span class="fs-5 fw-bold"><i class="bi bi-layout-text-sidebar-reverse me-2"></i>CRM Admin</span>
    </a>
    <hr>
    <ul class="nav nav-pills flex-column gap-1" id="sidebarNav">
      <li class="nav-item"><a class="nav-link active" data-page="dashboard"><i class="bi bi-speedometer2 me-2"></i>Dashboard</a></li>
      <li class="nav-item"><a class="nav-link" data-page="customers"><i class="bi bi-people me-2"></i>Customers</a></li>
      <li class="nav-item" id="navServices" style="display:none"><a class="nav-link" data-page="services"><i class="bi bi-box-seam me-2"></i>Services</a></li>
      <li class="nav-item"><a class="nav-link" data-page="projects"><i class="bi bi-kanban me-2"></i>Projects</a></li>
      <li class="nav-item"><a class="nav-link" data-page="opportunities"><i class="bi bi-bullseye me-2"></i>Opportunities</a></li>
      <li class="nav-item"><a class="nav-link" data-page="quotes"><i class="bi bi-receipt me-2"></i>Quotes</a></li>
      <li class="nav-item"><a class="nav-link" data-page="contracts"><i class="bi bi-file-earmark-text me-2"></i>Contracts</a></li>
      <li class="nav-item"><a class="nav-link" data-page="users" id="navUsers"><i class="bi bi-person-gear me-2"></i>Users</a></li>
    </ul>
    <hr>
    <div class="dropdown">
      <a class="d-flex align-items-center text-decoration-none dropdown-toggle" data-bs-toggle="dropdown">
        <img id="userAvatar" src="https://ui-avatars.com/api/?name=CRM&background=0D6EFD&color=fff" alt="" width="32" height="32" class="rounded-circle me-2">
        <div>
          <strong id="currentEmail">guest@local</strong>
          <div><span id="currentRole" class="badge bg-secondary">user</span></div>
        </div>
      </a>
      <ul class="dropdown-menu shadow">
        <li><a class="dropdown-item" href="#" id="btnSignOut"><i class="bi bi-box-arrow-right me-2"></i>Đăng xuất</a></li>
      </ul>
    </div>
  </aside>

  <!-- ========================= MAIN ========================= -->
  <main class="content-wrap">
    <div class="container-fluid py-3 py-lg-4">

      <!-- DASHBOARD -->
      <section id="page-dashboard" class="section-anchor">
        <div class="d-flex align-items-center mb-4">
          <h1 class="h3 mb-0"><i class="bi bi-speedometer2 me-2"></i>Dashboard</h1>
        </div>
        <div class="row g-3">
          <div class="col-6 col-lg-3"><div class="card card-shadow"><div class="card-body"><h6 class="text-secondary text-uppercase mb-1 small">Customers</h6><h2 class="fw-bold mb-0" id="kpiCustomers">0</h2></div></div></div>
          <div class="col-6 col-lg-3" id="kpiServicesWrap" style="display:none"><div class="card card-shadow"><div class="card-body"><h6 class="text-secondary text-uppercase mb-1 small">Services</h6><h2 class="fw-bold mb-0" id="kpiServices">0</h2></div></div></div>
          <div class="col-6 col-lg-3"><div class="card card-shadow"><div class="card-body"><h6 class="text-secondary text-uppercase mb-1 small">Projects</h6><h2 class="fw-bold mb-0" id="kpiProjects">0</h2></div></div></div>
          <div class="col-6 col-lg-3"><div class="card card-shadow"><div class="card-body"><h6 class="text-secondary text-uppercase mb-1 small">Opportunities</h6><h2 class="fw-bold mb-0" id="kpiOpportunities">0</h2></div></div></div>
        </div>
        <div class="card card-shadow mt-3"><div class="card-body"><div class="text-secondary">Tổng giá trị cơ hội: <span class="fw-bold" id="kpiOppValue">0</span></div></div></div>
      </section>

      <!-- CUSTOMERS -->
      <section id="page-customers" class="section-anchor d-none">
        <div class="d-flex align-items-center mb-4">
          <h1 class="h3 mb-0"><i class="bi bi-people me-2"></i>Customers</h1>
          <div class="ms-auto"><button class="btn btn-primary btn-sm" id="btnAddCustomer"><i class="bi bi-plus-lg me-1"></i>Thêm KH</button></div>
        </div>
        <div id="customerFormWrap" class="d-none"></div>
        <div class="card card-shadow"><div class="card-body p-0 table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-light"><tr><th>ID</th><th>Name</th><th class="d-none d-md-table-cell">Contact</th><th class="d-none d-lg-table-cell">Phone</th><th class="d-none d-lg-table-cell">Email</th><th class="d-none d-xl-table-cell">Tax</th><th style="width:120px;">Actions</th></tr></thead>
            <tbody id="customerTbody"></tbody>
          </table>
        </div></div>
      </section>

      <!-- SERVICES (DISABLED) -->
      <section id="page-services" class="section-anchor d-none"></section>

      <!-- PROJECTS -->
      <section id="page-projects" class="section-anchor d-none">
        <div class="d-flex align-items-center mb-4">
          <h1 class="h3 mb-0"><i class="bi bi-kanban me-2"></i>Projects</h1>
          <div class="ms-auto"><button class="btn btn-primary btn-sm" id="btnAddProject"><i class="bi bi-plus-lg me-1"></i>Thêm dự án</button></div>
        </div>
        <div id="projectFormWrap" class="d-none"></div>
        <div class="card card-shadow"><div class="card-body p-0 table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-light"><tr><th>ID</th><th>Tên dự án</th><th class="d-none d-md-table-cell">Khách hàng</th><th class="d-none d-lg-table-cell">Start</th><th class="d-none d-lg-table-cell">End</th><th>Status</th><th style="width:120px;">Actions</th></tr></thead>
            <tbody id="projectTbody"></tbody>
          </table>
        </div></div>
      </section>

      <!-- OPPORTUNITIES -->
      <section id="page-opportunities" class="section-anchor d-none">
        <div class="d-flex align-items-center mb-4">
          <h1 class="h3 mb-0"><i class="bi bi-bullseye me-2"></i>Opportunities</h1>
          <div class="ms-auto"><button class="btn btn-primary btn-sm" id="btnAddOpportunity"><i class="bi bi-plus-lg me-1"></i>Thêm cơ hội</button></div>
        </div>
        <div id="oppFormWrap" class="d-none"></div>
        <div class="card card-shadow"><div class="card-body p-0 table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-light"><tr><th>ID</th><th>Tên cơ hội</th><th class="d-none d-md-table-cell">Khách hàng</th><th>Giá trị</th><th>Stage</th><th style="width:120px;">Actions</th></tr></thead>
            <tbody id="oppTbody"></tbody>
          </table>
        </div></div>
      </section>

      <!-- QUOTES -->
      <section id="page-quotes" class="section-anchor d-none">
        <div class="d-flex align-items-center mb-4">
          <h1 class="h3 mb-0"><i class="bi bi-receipt me-2"></i>Quotes</h1>
          <div class="ms-auto"><button class="btn btn-primary btn-sm" id="btnAddQuote"><i class="bi bi-plus-lg me-1"></i>Thêm báo giá</button></div>
        </div>
        <div id="quoteFormWrap" class="d-none"></div>
        <div class="card card-shadow"><div class="card-body p-0 table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th>ID</th>
                <th class="d-none d-md-table-cell">Khách hàng</th>
                <th class="d-none d-lg-table-cell">Dự án</th>
                <th class="text-start">Nội dung</th>
                <th>Số tiền</th>
                <th class="d-none d-md-table-cell">Status</th>
                <th class="d-none d-lg-table-cell">Lần gửi</th>
                <th class="d-none d-xl-table-cell">PDF</th>
                <th style="width:120px;">Actions</th>
              </tr>
            </thead>
            <tbody id="quoteTbody"></tbody>
          </table>
        </div></div>
      </section>

      <!-- CONTRACTS -->
      <section id="page-contracts" class="section-anchor d-none">
        <div class="d-flex align-items-center mb-4">
          <h1 class="h3 mb-0"><i class="bi bi-file-earmark-text me-2"></i>Contracts</h1>
          <div class="ms-auto"><button class="btn btn-primary btn-sm" id="btnAddContract"><i class="bi bi-plus-lg me-1"></i>Thêm HĐ</button></div>
        </div>
        <div id="contractFormWrap" class="d-none"></div>
        <div class="card card-shadow"><div class="card-body p-0 table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-light"><tr><th>ID</th><th>Dự án</th><th class="d-none d-md-table-cell">Khách hàng</th><th>Giá trị</th><th>Status</th><th style="width:120px;">Actions</th></tr></thead>
            <tbody id="contractTbody"></tbody>
          </table>
        </div></div>
      </section>

      <!-- USERS -->
      <section id="page-users" class="section-anchor d-none">
        <div class="d-flex align-items-center mb-4">
          <h1 class="h3 mb-0"><i class="bi bi-person-gear me-2"></i>Users</h1>
          <div class="ms-auto"><button class="btn btn-primary btn-sm" id="btnAddUser"><i class="bi bi-plus-lg me-1"></i>Thêm user</button></div>
        </div>
        <div id="userFormWrap" class="d-none"></div>
        <div class="card card-shadow"><div class="card-body p-0 table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-light"><tr><th>Email</th><th>Role</th><th>Active</th><th style="width:120px;">Actions</th></tr></thead>
            <tbody id="userTbody"></tbody>
          </table>
        </div></div>
      </section>

    </div>
  </main>

  <!-- ========================= SCRIPTS ========================= -->
  <script>
    /* ===== CONFIGURATION ===== */
    const CONFIG = {
      SUPABASE_URL: 'https://sdmjdhmkjyadgyfodpsf.supabase.co',
      SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNkbWpkaG1ranlhZGd5Zm9kcHNmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM2ODQyNjIsImV4cCI6MjA2OTI2MDI2Mn0.Org3PD8CNmqCxC8ylbNiPA5Guo0w0srXgxyF2s2ZHG0',
      DEBOUNCE_DELAY: 300,
      TOAST_DURATION: 3000
    };

    /* ===== FORM BUILDERS ===== */
    const crmForms = {
      customer(id = '', viewOnly = false) {
        const wrap = document.getElementById('customerFormWrap');
        const isEdit = !!id;
        
        // RLS: Kiểm tra quyền chỉnh sửa
        if (isEdit && !viewOnly) {
          const customer = state.customers.find(x => x.id === id);
          if (customer && !utils.canEdit(customer)) {
            utils.showToast('Bạn không có quyền sửa khách hàng này', 'error');
            return;
          }
        }
        
        const c = isEdit ? state.customers.find(x => x.id === id) : {};
        
        wrap.classList.remove('d-none');
        wrap.scrollIntoView({ behavior: 'smooth', block: 'start' });
        
        wrap.innerHTML = `
          <div class="card card-shadow mb-4 fade-in">
            <div class="card-body">
              <h5 class="card-title mb-3">${viewOnly ? 'Xem' : (isEdit ? 'Sửa' : 'Thêm')} khách hàng</h5>
              <form id="customerForm">
                <div class="row g-3">
                  <div class="col-md-2">
                    <label class="form-label">ID</label>
                    <input class="form-control" disabled id="cust_id" value="${isEdit ? c.id : generators.customerId()}">
                  </div>
                  <div class="col-md-10 position-relative">
                    <label class="form-label">Tên khách hàng <span class="text-danger">*</span></label>
                    <input class="form-control" id="cust_name" value="${c?.name || ''}" autocomplete="off" ${viewOnly ? 'disabled' : 'required'}>
                    <div id="cust_name_sugs" class="suggestions d-none"></div>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Người liên hệ</label>
                    <input class="form-control" id="cust_contact" value="${c?.contact_person || ''}" ${viewOnly ? 'disabled' : ''}>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Phone</label>
                    <input class="form-control" id="cust_phone" value="${c?.phone || ''}" ${viewOnly ? 'disabled' : ''}>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-control" id="cust_email" value="${c?.email || ''}" ${viewOnly ? 'disabled' : ''}>
                  </div>
                  <div class="col-md-8">
                    <label class="form-label">Địa chỉ</label>
                    <input class="form-control" id="cust_address" value="${c?.address || ''}" ${viewOnly ? 'disabled' : ''}>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Mã số thuế</label>
                    <input class="form-control" id="cust_tax" value="${c?.tax_code || ''}" ${viewOnly ? 'disabled' : ''}>
                  </div>
                </div>
                <div class="mt-3 d-flex gap-2">
                  ${!viewOnly ? `
                    <button type="submit" class="btn btn-primary">
                      <i class="bi bi-check2-circle me-1"></i>Lưu
                    </button>
                  ` : ''}
                  <button type="button" class="btn btn-outline-secondary" onclick="document.getElementById('customerFormWrap').classList.add('d-none')">
                    ${viewOnly ? 'Đóng' : 'Hủy'}
                  </button>
                </div>
              </form>
            </div>
          </div>
        `;
        
        if (!viewOnly) {
          // Attach events
          document.getElementById('customerForm').onsubmit = (e) => {
            e.preventDefault();
            handlers.saveCustomer(id);
          };
          
          const nameInput = document.getElementById('cust_name');
          nameInput.oninput = utils.debounce(() => autocomplete.suggestExistingCustomer(nameInput.value), CONFIG.DEBOUNCE_DELAY);
        }
      },
      
      project(id = '', viewOnly = false) {
        const wrap = document.getElementById('projectFormWrap');
        const isEdit = !!id;
        
        // RLS: Kiểm tra quyền chỉnh sửa
        if (isEdit && !viewOnly) {
          const project = state.projects.find(x => x.project_id === id);
          if (project && !utils.canEdit(project)) {
            utils.showToast('Bạn không có quyền sửa dự án này', 'error');
            return;
          }
        }
        
        const p = isEdit ? state.projects.find(x => x.project_id === id) : {};
        const customer = state.cache.customerMap.get(p?.customer_id);
        
        wrap.classList.remove('d-none');
        window.scrollTo({ top: 0, behavior: 'smooth' });
        
        wrap.innerHTML = `
          <div class="card card-shadow mb-4 fade-in">
            <div class="card-body">
              <h5 class="card-title mb-3">${viewOnly ? 'Xem' : (isEdit ? 'Sửa' : 'Thêm')} dự án</h5>
              <form id="projectForm">
                <div class="row g-3">
                  <div class="col-md-3">
                    <label class="form-label">ID</label>
                    <input class="form-control" disabled id="pr_id" value="${isEdit ? p.project_id : generators.projectId()}">
                  </div>
                  <div class="col-md-9">
                    <label class="form-label">Tên dự án <span class="text-danger">*</span></label>
                    <input class="form-control" id="pr_name" value="${p?.project_name || ''}" ${viewOnly ? 'disabled' : 'required'}>
                  </div>
                  <div class="col-md-6 position-relative">
                    <label class="form-label">Khách hàng <span class="text-danger">*</span></label>
                    <input class="form-control" id="pr_client" autocomplete="off" value="${customer?.name || ''}" ${viewOnly ? 'disabled' : 'required'}>
                    <div id="pr_client_sugs" class="suggestions d-none"></div>
                    <input type="hidden" id="pr_client_id" value="${p?.customer_id || ''}">
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">Start</label>
                    <input type="date" class="form-control" id="pr_start" value="${p?.start_date || ''}" ${viewOnly ? 'disabled' : ''}>
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">End</label>
                    <input type="date" class="form-control" id="pr_end" value="${p?.end_date || ''}" ${viewOnly ? 'disabled' : ''}>
                  </div>
                  <div class="col-md-12">
                    <label class="form-label">Status</label>
                    <select class="form-select" id="pr_status" ${viewOnly ? 'disabled' : ''}>
                      <option ${p?.status === 'Chuẩn bị' ? 'selected' : ''}>Chuẩn bị</option>
                      <option ${p?.status === 'Đang triển khai' ? 'selected' : ''}>Đang triển khai</option>
                      <option ${p?.status === 'Hoàn thành' ? 'selected' : ''}>Hoàn thành</option>
                    </select>
                  </div>
                  <div class="col-12">
                    <label class="form-label">Mô tả</label>
                    <textarea class="form-control" rows="2" id="pr_desc" ${viewOnly ? 'disabled' : ''}>${p?.description || ''}</textarea>
                  </div>
                </div>
                <div class="mt-3 d-flex gap-2">
                  ${!viewOnly ? `
                    <button type="submit" class="btn btn-primary">
                      <i class="bi bi-check2-circle me-1"></i>Lưu
                    </button>
                  ` : ''}
                  <button type="button" class="btn btn-outline-secondary" onclick="document.getElementById('projectFormWrap').classList.add('d-none')">
                    ${viewOnly ? 'Đóng' : 'Hủy'}
                  </button>
                </div>
              </form>
            </div>
          </div>
        `;
        
        if (!viewOnly) {
          document.getElementById('projectForm').onsubmit = (e) => {
            e.preventDefault();
            handlers.saveProject(id);
          };
          
          const clientInput = document.getElementById('pr_client');
          clientInput.oninput = utils.debounce(() => autocomplete.suggestCustomer(clientInput.value, 'pr_client'), CONFIG.DEBOUNCE_DELAY);
        }
      },
      
      opportunity(id = '', viewOnly = false) {
        const wrap = document.getElementById('oppFormWrap');
        const isEdit = !!id;
        
        // RLS: Kiểm tra quyền chỉnh sửa
        if (isEdit && !viewOnly) {
          const opportunity = state.opportunities.find(x => x.opportunity_id === id);
          if (opportunity && !utils.canEdit(opportunity)) {
            utils.showToast('Bạn không có quyền sửa cơ hội này', 'error');
            return;
          }
        }
        
        const o = isEdit ? state.opportunities.find(x => x.opportunity_id === id) : {};
        const customer = state.cache.customerMap.get(o?.customer_id);
        
        wrap.classList.remove('d-none');
        window.scrollTo({ top: 0, behavior: 'smooth' });
        
        wrap.innerHTML = `
          <div class="card card-shadow mb-4 fade-in">
            <div class="card-body">
              <h5 class="card-title mb-3">${viewOnly ? 'Xem' : (isEdit ? 'Sửa' : 'Thêm')} cơ hội</h5>
              <form id="oppForm">
                <div class="row g-3">
                  <div class="col-md-3">
                    <label class="form-label">ID</label>
                    <input class="form-control" disabled id="op_id" value="${isEdit ? o.opportunity_id : generators.opportunityId()}">
                  </div>
                  <div class="col-md-9">
                    <label class="form-label">Tên cơ hội <span class="text-danger">*</span></label>
                    <input class="form-control" id="op_name" value="${o?.name || ''}" ${viewOnly ? 'disabled' : 'required'}>
                  </div>
                  <div class="col-md-6 position-relative">
                    <label class="form-label">Khách hàng <span class="text-danger">*</span></label>
                    <input class="form-control" id="op_client" autocomplete="off" value="${customer?.name || ''}" ${viewOnly ? 'disabled' : 'required'}>
                    <div id="op_client_sugs" class="suggestions d-none"></div>
                    <input type="hidden" id="op_client_id" value="${o?.customer_id || ''}">
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Giá trị kỳ vọng</label>
                    <input type="number" class="form-control" id="op_val" value="${o?.expected_value || 0}" ${viewOnly ? 'disabled' : ''}>
                  </div>
                  <div class="col-md-12">
                    <label class="form-label">Stage</label>
                    <select class="form-select" id="op_stage" ${viewOnly ? 'disabled' : ''}>
                      <option ${o?.stage === 'mới' ? 'selected' : ''}>mới</option>
                      <option ${o?.stage === 'đánh giá' ? 'selected' : ''}>đánh giá</option>
                      <option ${o?.stage === 'đàm phán' ? 'selected' : ''}>đàm phán</option>
                      <option ${o?.stage === 'đã thắng' ? 'selected' : ''}>đã thắng</option>
                      <option ${o?.stage === 'đã mất' ? 'selected' : ''}>đã mất</option>
                    </select>
                  </div>
                </div>
                <div class="mt-3 d-flex gap-2">
                  ${!viewOnly ? `
                    <button type="submit" class="btn btn-primary">
                      <i class="bi bi-check2-circle me-1"></i>Lưu
                    </button>
                  ` : ''}
                  <button type="button" class="btn btn-outline-secondary" onclick="document.getElementById('oppFormWrap').classList.add('d-none')">
                    ${viewOnly ? 'Đóng' : 'Hủy'}
                  </button>
                </div>
              </form>
            </div>
          </div>
        `;
        
        if (!viewOnly) {
          document.getElementById('oppForm').onsubmit = (e) => {
            e.preventDefault();
            handlers.saveOpportunity(id);
          };
          
          const clientInput = document.getElementById('op_client');
          clientInput.oninput = utils.debounce(() => autocomplete.suggestCustomer(clientInput.value, 'op_client'), CONFIG.DEBOUNCE_DELAY);
        }
      },
      
      quote(id = '', viewOnly = false) {
        const wrap = document.getElementById('quoteFormWrap');
        const isEdit = !!id;
        
        // RLS: Kiểm tra quyền chỉnh sửa
        if (isEdit && !viewOnly) {
          const quote = state.quotes.find(x => x.quotes_id === id);
          if (quote && !utils.canEdit(quote)) {
            utils.showToast('Bạn không có quyền sửa báo giá này', 'error');
            return;
          }
        }
        
        const q = isEdit ? state.quotes.find(x => x.quotes_id === id) : {};
        const customer = state.cache.customerMap.get(q?.customer_id);
        const project = state.cache.projectMap.get(q?.project_id);
        
        wrap.classList.remove('d-none');
        window.scrollTo({ top: 0, behavior: 'smooth' });
        
        wrap.innerHTML = `
          <div class="card card-shadow mb-4 fade-in">
            <div class="card-body">
              <h5 class="card-title mb-3">${viewOnly ? 'Xem' : (isEdit ? 'Sửa' : 'Thêm')} báo giá</h5>
              <form id="quoteForm">
                <div class="row g-3">
                  <div class="col-md-3">
                    <label class="form-label">ID</label>
                    <input class="form-control" disabled id="q_id" value="${isEdit ? q.quotes_id : generators.quoteId()}">
                  </div>
                  <div class="col-md-9 position-relative">
                    <label class="form-label">Khách hàng <span class="text-danger">*</span></label>
                    <input class="form-control" id="q_client" autocomplete="off" value="${customer?.name || ''}" ${viewOnly ? 'disabled' : 'required'}>
                    <div id="q_client_sugs" class="suggestions d-none"></div>
                    <input type="hidden" id="q_client_id" value="${q?.customer_id || ''}">
                  </div>
                  <div class="col-md-6 position-relative">
                    <label class="form-label">Dự án</label>
                    <input class="form-control" id="q_project" autocomplete="off" value="${project?.project_name || ''}" ${viewOnly ? 'disabled' : ''}>
                    <div id="q_project_sugs" class="suggestions d-none"></div>
                    <input type="hidden" id="q_project_id" value="${q?.project_id || ''}">
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Số tiền</label>
                    <input type="number" class="form-control" id="q_amount" value="${q?.amount || 0}" ${viewOnly ? 'disabled' : ''}>
                  </div>
                  <div class="col-12">
                    <label class="form-label">Nội dung</label>
                    <textarea class="form-control" rows="2" id="q_desc" ${viewOnly ? 'disabled' : ''}>${q?.description || ''}</textarea>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Status</label>
                    <select class="form-select" id="q_status" ${viewOnly ? 'disabled' : ''}>
                      <option ${q?.status === 'nháp' ? 'selected' : ''}>nháp</option>
                      <option ${q?.status === 'đã gửi' ? 'selected' : ''}>đã gửi</option>
                      <option ${q?.status === 'chấp nhận' ? 'selected' : ''}>chấp nhận</option>
                      <option ${q?.status === 'từ chối' ? 'selected' : ''}>từ chối</option>
                    </select>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Lần gửi</label>
                    <input type="number" class="form-control" id="q_send" value="${q?.send_count || 0}" ${viewOnly ? 'disabled' : ''}>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">PDF URL</label>
                    <input class="form-control" id="q_pdf" placeholder="https://...pdf" value="${q?.pdf_url || ''}" ${viewOnly ? 'disabled' : ''}>
                  </div>
                </div>
                <div class="mt-3 d-flex gap-2">
                  ${!viewOnly ? `
                    <button type="submit" class="btn btn-primary">
                      <i class="bi bi-check2-circle me-1"></i>Lưu báo giá
                    </button>
                  ` : ''}
                  <button type="button" class="btn btn-outline-secondary" onclick="document.getElementById('quoteFormWrap').classList.add('d-none')">
                    ${viewOnly ? 'Đóng' : 'Hủy'}
                  </button>
                </div>
              </form>
            </div>
          </div>
        `;
        
        if (!viewOnly) {
          document.getElementById('quoteForm').onsubmit = (e) => {
            e.preventDefault();
            handlers.saveQuote(id);
          };
          
          const clientInput = document.getElementById('q_client');
          clientInput.oninput = utils.debounce(() => autocomplete.suggestCustomer(clientInput.value, 'q_client'), CONFIG.DEBOUNCE_DELAY);
          
          const projectInput = document.getElementById('q_project');
          projectInput.oninput = utils.debounce(() => autocomplete.suggestProject(projectInput.value, 'q_project'), CONFIG.DEBOUNCE_DELAY);
        }
      },
      
      contract(id = '', viewOnly = false) {
        const wrap = document.getElementById('contractFormWrap');
        const isEdit = !!id;
        
        // RLS: Kiểm tra quyền chỉnh sửa
        if (isEdit && !viewOnly) {
          const contract = state.contracts.find(x => x.contract_id === id);
          if (contract && !utils.canEdit(contract)) {
            utils.showToast('Bạn không có quyền sửa hợp đồng này', 'error');
            return;
          }
        }
        
        const ct = isEdit ? state.contracts.find(x => x.contract_id === id) : {};
        const project = state.cache.projectMap.get(ct?.project_id);
        
        wrap.classList.remove('d-none');
        window.scrollTo({ top: 0, behavior: 'smooth' });
        
        wrap.innerHTML = `
          <div class="card card-shadow mb-4 fade-in">
            <div class="card-body">
              <h5 class="card-title mb-3">${viewOnly ? 'Xem' : (isEdit ? 'Sửa' : 'Thêm')} hợp đồng</h5>
              <form id="contractForm">
                <div class="row g-3">
                  <div class="col-md-3">
                    <label class="form-label">ID</label>
                    <input class="form-control" disabled id="ct_id" value="${isEdit ? ct.contract_id : generators.contractId()}">
                  </div>
                  <div class="col-md-9 position-relative">
                    <label class="form-label">Dự án <span class="text-danger">*</span></label>
                    <input class="form-control" id="ct_proj" autocomplete="off" value="${project?.project_name || ''}" ${viewOnly ? 'disabled' : 'required'}>
                    <div id="ct_proj_sugs" class="suggestions d-none"></div>
                    <input type="hidden" id="ct_proj_id" value="${ct?.project_id || ''}">
                  </div>
                  <div class="col-md-6 position-relative">
                    <label class="form-label">Báo giá (tùy chọn)</label>
                    <input class="form-control" id="ct_quote" autocomplete="off" value="${ct?.quotes_id || ''}" ${viewOnly ? 'disabled' : ''}>
                    <div id="ct_quote_sugs" class="suggestions d-none"></div>
                    <input type="hidden" id="ct_quote_id" value="${ct?.quotes_id || ''}">
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Giá trị</label>
                    <input type="number" class="form-control" id="ct_val" value="${ct?.value || 0}" ${viewOnly ? 'disabled' : ''}>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Ngày HĐ</label>
                    <input type="date" class="form-control" id="ct_date" value="${ct?.contract_date || ''}" ${viewOnly ? 'disabled' : ''}>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Trạng thái</label>
                    <select class="form-select" id="ct_status" ${viewOnly ? 'disabled' : ''}>
                      <option ${ct?.status === 'hiệu lực' ? 'selected' : ''}>hiệu lực</option>
                      <option ${ct?.status === 'hoàn thành' ? 'selected' : ''}>hoàn thành</option>
                      <option ${ct?.status === 'hủy' ? 'selected' : ''}>hủy</option>
                    </select>
                  </div>
                </div>
                <div class="mt-3 d-flex gap-2">
                  ${!viewOnly ? `
                    <button type="submit" class="btn btn-primary">
                      <i class="bi bi-check2-circle me-1"></i>Lưu
                    </button>
                  ` : ''}
                  <button type="button" class="btn btn-outline-secondary" onclick="document.getElementById('contractFormWrap').classList.add('d-none')">
                    ${viewOnly ? 'Đóng' : 'Hủy'}
                  </button>
                </div>
              </form>
            </div>
          </div>
        `;
        
        if (!viewOnly) {
          document.getElementById('contractForm').onsubmit = (e) => {
            e.preventDefault();
            handlers.saveContract(id);
          };
          
          const projInput = document.getElementById('ct_proj');
          projInput.oninput = utils.debounce(() => autocomplete.suggestProject(projInput.value, 'ct_proj'), CONFIG.DEBOUNCE_DELAY);
          
          const quoteInput = document.getElementById('ct_quote');
          quoteInput.oninput = utils.debounce(() => autocomplete.suggestQuote(quoteInput.value, 'ct_quote'), CONFIG.DEBOUNCE_DELAY);
        }
      },
      
      user(id = '') {
        const wrap = document.getElementById('userFormWrap');
        const isEdit = !!id;
        const u = isEdit ? state.users.find(x => x.id === id) : {};
        
        wrap.classList.remove('d-none');
        wrap.innerHTML = `
          <div class="card card-shadow mb-4 fade-in">
            <div class="card-body">
              <h5 class="card-title mb-3">${isEdit ? 'Sửa' : 'Thêm'} user</h5>
              <form id="userForm">
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label">Email <span class="text-danger">*</span></label>
                    <input type="email" class="form-control" id="us_email" value="${u?.email || ''}" ${isEdit ? 'disabled' : 'required'}>
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">Role</label>
                    <select class="form-select" id="us_role">
                      <option value="user" ${u?.role === 'user' ? 'selected' : ''}>user</option>
                      <option value="admin" ${u?.role === 'admin' ? 'selected' : ''}>admin</option>
                      <option value="BOM" ${u?.role === 'BOM' ? 'selected' : ''}>BOM</option>
                    </select>
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">Active</label>
                    <select class="form-select" id="us_active">
                      <option value="true" ${u?.active ? 'selected' : ''}>true</option>
                      <option value="false" ${!u?.active ? 'selected' : ''}>false</option>
                    </select>
                  </div>
                </div>
                <div class="mt-3 d-flex gap-2">
                  <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check2-circle me-1"></i>Lưu
                  </button>
                  <button type="button" class="btn btn-outline-secondary" onclick="document.getElementById('userFormWrap').classList.add('d-none')">
                    Hủy
                  </button>
                </div>
              </form>
            </div>
          </div>
        `;
        
        document.getElementById('userForm').onsubmit = (e) => {
          e.preventDefault();
          handlers.saveUser(id);
        };
      }
    };

    /* ===== SUPABASE CLIENT ===== */
    const sb = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);

    /* ===== APPLICATION STATE ===== */
    const state = {
      currentUser: { 
        id: null,      // UUID từ auth.uid() 
        email: null, 
        role: 'user' 
      },
      customers: [],
      services: [],
      projects: [],
      opportunities: [],
      quotes: [],
      contracts: [],
      users: [],
      cache: {
        customerMap: new Map(),
        projectMap: new Map()
      }
    };

    /* ===== UTILITY FUNCTIONS ===== */
    const utils = {
      pad: (n, w) => String(n).padStart(w, '0'),
      
      getWeekNumber(date = new Date()) {
        const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
        const dayNum = d.getUTCDay() || 7;
        d.setUTCDate(d.getUTCDate() + 4 - dayNum);
        const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
        return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
      },
      
      money: (n) => (n || 0).toLocaleString('vi-VN'),
      
      debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      },
      
      showToast(message, type = 'success') {
        const toastContainer = document.querySelector('.toast-container');
        const toastEl = document.createElement('div');
        toastEl.className = `toast align-items-center text-white bg-${type === 'error' ? 'danger' : 'success'} border-0 fade show`;
        toastEl.innerHTML = `
          <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
          </div>
        `;
        toastContainer.appendChild(toastEl);
        setTimeout(() => toastEl.remove(), CONFIG.TOAST_DURATION);
      },
      
      showLoading(element) {
        const originalContent = element.innerHTML;
        element.innerHTML = '<div class="loading mx-auto"></div>';
        element.disabled = true;
        return () => {
          element.innerHTML = originalContent;
          element.disabled = false;
        };
      },

      // RLS: Kiểm tra quyền chỉnh sửa record
      canEdit(record) {
        // Admin/BOM có quyền sửa tất cả
        if (['admin', 'BOM'].includes(state.currentUser.role)) {
          return true;
        }
        
        // User chỉ được sửa record do họ tạo ra
        return record.created_by === state.currentUser.id;
      },

      // Tạo badge hiển thị quyền
      getPermissionBadge(record) {
        if (this.canEdit(record)) {
          return '<span class="permission-badge bg-success text-white">Edit</span>';
        } else {
          return '<span class="permission-badge bg-warning text-dark">View</span>';
        }
      }
    };

    /* ===== ID GENERATORS ===== */
    const generators = {
      customerId() {
        const used = state.customers.map(c => parseInt(c.id?.slice(1), 10)).filter(Number.isFinite);
        for (let i = 1; i < 10000; i++) {
          if (!used.includes(i)) return 'C' + utils.pad(i, 4);
        }
        throw new Error('Hết mã khách hàng');
      },
      
      projectId() {
        const y = new Date().getFullYear().toString().slice(-2);
        const used = state.projects
          .filter(p => p.project_id?.startsWith('P_' + y))
          .map(p => parseInt(p.project_id.slice(4), 10))
          .filter(Number.isFinite);
        for (let i = 1; i < 1000; i++) {
          if (!used.includes(i)) return 'P_' + y + utils.pad(i, 3);
        }
        throw new Error('Hết mã dự án');
      },
      
      opportunityId() {
        const used = state.opportunities
          .map(o => parseInt(o.opportunity_id?.split('_')[1], 10))
          .filter(Number.isFinite);
        for (let i = 1; i < 100000; i++) {
          if (!used.includes(i)) return 'Op_' + utils.pad(i, 5);
        }
        throw new Error('Hết mã cơ hội');
      },
      
      quoteId() {
        const now = new Date();
        const y = now.getFullYear().toString().slice(-2);
        const w = utils.pad(utils.getWeekNumber(now), 2);
        const prefix = `Q_${y}${w}`;
        const used = state.quotes
          .filter(q => q.quotes_id?.startsWith(prefix))
          .map(q => parseInt(q.quotes_id.slice(6), 10))
          .filter(Number.isFinite);
        for (let i = 1; i <= 99; i++) {
          if (!used.includes(i)) return prefix + utils.pad(i, 2);
        }
        throw new Error('Hết mã báo giá');
      },
      
      contractId() {
        const now = new Date();
        const y = now.getFullYear().toString().slice(-2);
        const w = utils.pad(utils.getWeekNumber(now), 2);
        const prefix = `HD_${y}${w}`;
        const used = state.contracts
          .filter(c => c.contract_id?.startsWith(prefix))
          .map(c => parseInt(c.contract_id.slice(7), 10))
          .filter(Number.isFinite);
        for (let i = 1; i <= 99; i++) {
          if (!used.includes(i)) return prefix + utils.pad(i, 2);
        }
        throw new Error('Hết mã hợp đồng');
      }
    };

    /* ===== UI HELPERS ===== */
    const ui = {
      showSection(page) {
        document.querySelectorAll('[id^="page-"]').forEach(el => el.classList.add('d-none'));
        const section = document.getElementById(`page-${page}`);
        if (section) {
          section.classList.remove('d-none');
          section.classList.add('fade-in');
        }
        
        document.querySelectorAll('.sidebar .nav-link').forEach(a => {
          if (a.dataset.page === page) {
            a.classList.add('active');
          } else {
            a.classList.remove('active');
          }
        });
        
        // Close mobile sidebar
        if (window.innerWidth < 992) {
          ui.toggleSidebar(false);
        }
      },
      
      toggleSidebar(show) {
        const sidebar = document.getElementById('sidebar');
        const backdrop = document.getElementById('sidebarBackdrop');
        
        if (show === undefined) {
          show = !sidebar.classList.contains('show');
        }
        
        if (show) {
          sidebar.classList.add('show');
          backdrop.classList.add('show');
        } else {
          sidebar.classList.remove('show');
          backdrop.classList.remove('show');
        }
      },
      
      setKPIs() {
        document.getElementById('kpiCustomers').textContent = state.customers.length;
        document.getElementById('kpiProjects').textContent = state.projects.length;
        document.getElementById('kpiOpportunities').textContent = state.opportunities.length;
        const totalValue = state.opportunities.reduce((sum, o) => sum + (o.expected_value || 0), 0);
        document.getElementById('kpiOppValue').textContent = utils.money(totalValue) + ' đ';
      }
    };

    /* ===== DATA LOADING ===== */
    async function loadData() {
      try {
        // RLS: Với RLS enabled, mỗi user chỉ load được data thuộc quyền của họ
        const [customersRes, projectsRes, opportunitiesRes, quotesRes, contractsRes, usersRes] = await Promise.all([
          sb.from('customers').select('*').order('id'),
          sb.from('projects').select('*').order('project_id'),
          sb.from('opportunities').select('*').order('opportunity_id'),
          sb.from('quotes').select('*').order('quotes_id'),
          sb.from('contracts').select('*').order('contract_id'),
          sb.from('user_profiles').select('*')
        ]);

        if (customersRes.error) console.error('Error loading customers:', customersRes.error);
        if (projectsRes.error) console.error('Error loading projects:', projectsRes.error);
        if (opportunitiesRes.error) console.error('Error loading opportunities:', opportunitiesRes.error);
        if (quotesRes.error) console.error('Error loading quotes:', quotesRes.error);
        if (contractsRes.error) console.error('Error loading contracts:', contractsRes.error);
        if (usersRes.error) console.error('Error loading users:', usersRes.error);

        state.customers = customersRes.data || [];
        state.projects = projectsRes.data || [];
        state.opportunities = opportunitiesRes.data || [];
        state.quotes = quotesRes.data || [];
        state.contracts = contractsRes.data || [];
        state.users = usersRes.data || [];

        // Update cache
        state.cache.customerMap.clear();
        state.customers.forEach(c => state.cache.customerMap.set(c.id, c));
        
        state.cache.projectMap.clear();
        state.projects.forEach(p => state.cache.projectMap.set(p.project_id, p));
        
      } catch (error) {
        console.error('Error loading data:', error);
        utils.showToast('Lỗi khi tải dữ liệu', 'error');
      }
    }

    /* ===== CRUD OPERATIONS ===== */
    const crud = {
      async create(table, data) {
        try {
          // RLS: created_by sẽ tự động được set = auth.uid() bởi database default
          const { error } = await sb.from(table).insert([data]);
          if (error) throw error;
          await loadData();
          utils.showToast('Thêm mới thành công');
          return true;
        } catch (error) {
          console.error('Create error:', error);
          utils.showToast(error.message, 'error');
          return false;
        }
      },
      
      async update(table, data, matchColumn, matchValue) {
        try {
          const { error } = await sb.from(table).update(data).eq(matchColumn, matchValue);
          if (error) throw error;
          await loadData();
          utils.showToast('Cập nhật thành công');
          return true;
        } catch (error) {
          console.error('Update error:', error);
          utils.showToast(error.message, 'error');
          return false;
        }
      },
      
      async delete(table, matchColumn, matchValue) {
        try {
          const { error } = await sb.from(table).delete().eq(matchColumn, matchValue);
          if (error) throw error;
          await loadData();
          utils.showToast('Xóa thành công');
          return true;
        } catch (error) {
          console.error('Delete error:', error);
          utils.showToast(error.message, 'error');
          return false;
        }
      }
    };

    /* ===== RENDER FUNCTIONS ===== */
    const renderers = {
      dashboard() {
        ui.setKPIs();
      },
      
      customers() {
        const tbody = document.getElementById('customerTbody');
        
        tbody.innerHTML = state.customers.map(c => {
          const canEdit = utils.canEdit(c);
          return `
            <tr>
              <td>${c.id}</td>
              <td class="text-start fw-medium">${c.name || ''}</td>
              <td class="d-none d-md-table-cell">${c.contact_person || ''}</td>
              <td class="d-none d-lg-table-cell">${c.phone || ''}</td>
              <td class="d-none d-lg-table-cell">${c.email || ''}</td>
              <td class="d-none d-xl-table-cell">${c.tax_code || ''}</td>
              <td>
                <div class="d-flex flex-column gap-1">
                  ${utils.getPermissionBadge(c)}
                  <div class="btn-group btn-group-sm">
                    ${canEdit ? `
                      <button class="btn btn-outline-secondary" onclick="crmForms.customer('${c.id}')">
                        <i class="bi bi-pencil-square"></i>
                      </button>
                      <button class="btn btn-outline-danger" onclick="handlers.deleteCustomer('${c.id}')">
                        <i class="bi bi-trash"></i>
                      </button>
                    ` : `
                      <button class="btn btn-outline-secondary" onclick="crmForms.customer('${c.id}', true)">
                        <i class="bi bi-eye"></i>
                      </button>
                    `}
                  </div>
                </div>
              </td>
            </tr>
          `;
        }).join('');
      },
      
      projects() {
        const tbody = document.getElementById('projectTbody');
        tbody.innerHTML = state.projects.map(p => {
          const customer = state.cache.customerMap.get(p.customer_id);
          const canEdit = utils.canEdit(p);
          return `
            <tr>
              <td>${p.project_id}</td>
              <td class="text-start fw-medium">${p.project_name || ''}</td>
              <td class="d-none d-md-table-cell">${customer ? customer.name : p.customer_id}</td>
              <td class="d-none d-lg-table-cell">${p.start_date || ''}</td>
              <td class="d-none d-lg-table-cell">${p.end_date || ''}</td>
              <td><span class="badge bg-secondary">${p.status || ''}</span></td>
              <td>
                <div class="d-flex flex-column gap-1">
                  ${utils.getPermissionBadge(p)}
                  <div class="btn-group btn-group-sm">
                    ${canEdit ? `
                      <button class="btn btn-outline-secondary" onclick="crmForms.project('${p.project_id}')">
                        <i class="bi bi-pencil-square"></i>
                      </button>
                      <button class="btn btn-outline-danger" onclick="handlers.deleteProject('${p.project_id}')">
                        <i class="bi bi-trash"></i>
                      </button>
                    ` : `
                      <button class="btn btn-outline-secondary" onclick="crmForms.project('${p.project_id}', true)">
                        <i class="bi bi-eye"></i>
                      </button>
                    `}
                  </div>
                </div>
              </td>
            </tr>
          `;
        }).join('');
      },
      
      opportunities() {
        const tbody = document.getElementById('oppTbody');
        tbody.innerHTML = state.opportunities.map(o => {
          const customer = state.cache.customerMap.get(o.customer_id);
          const canEdit = utils.canEdit(o);
          return `
            <tr>
              <td>${o.opportunity_id}</td>
              <td class="text-start fw-medium">${o.name || ''}</td>
              <td class="d-none d-md-table-cell">${customer ? customer.name : o.customer_id}</td>
              <td>${utils.money(o.expected_value)}</td>
              <td><span class="badge bg-info">${o.stage || ''}</span></td>
              <td>
                <div class="d-flex flex-column gap-1">
                  ${utils.getPermissionBadge(o)}
                  <div class="btn-group btn-group-sm">
                    ${canEdit ? `
                      <button class="btn btn-outline-secondary" onclick="crmForms.opportunity('${o.opportunity_id}')">
                        <i class="bi bi-pencil-square"></i>
                      </button>
                      <button class="btn btn-outline-danger" onclick="handlers.deleteOpportunity('${o.opportunity_id}')">
                        <i class="bi bi-trash"></i>
                      </button>
                    ` : `
                      <button class="btn btn-outline-secondary" onclick="crmForms.opportunity('${o.opportunity_id}', true)">
                        <i class="bi bi-eye"></i>
                      </button>
                    `}
                  </div>
                </div>
              </td>
            </tr>
          `;
        }).join('');
      },
      
      quotes() {
        const tbody = document.getElementById('quoteTbody');
        tbody.innerHTML = state.quotes.map(q => {
          const customer = state.cache.customerMap.get(q.customer_id);
          const project = state.cache.projectMap.get(q.project_id);
          const canEdit = utils.canEdit(q);
          return `
            <tr>
              <td>${q.quotes_id}</td>
              <td class="d-none d-md-table-cell">${customer ? customer.name : q.customer_id}</td>
              <td class="d-none d-lg-table-cell">${project ? project.project_name : (q.project_id || '')}</td>
              <td class="text-start">${q.description || ''}</td>
              <td>${utils.money(q.amount)}</td>
              <td class="d-none d-md-table-cell"><span class="badge bg-secondary">${q.status || ''}</span></td>
              <td class="d-none d-lg-table-cell">${q.send_count || 0}</td>
              <td class="d-none d-xl-table-cell">${q.pdf_url ? `<a href="${q.pdf_url}" target="_blank">PDF</a>` : ''}</td>
              <td>
                <div class="d-flex flex-column gap-1">
                  ${utils.getPermissionBadge(q)}
                  <div class="btn-group btn-group-sm">
                    ${canEdit ? `
                      <button class="btn btn-outline-secondary" onclick="crmForms.quote('${q.quotes_id}')">
                        <i class="bi bi-pencil-square"></i>
                      </button>
                      <button class="btn btn-outline-danger" onclick="handlers.deleteQuote('${q.quotes_id}')">
                        <i class="bi bi-trash"></i>
                      </button>
                    ` : `
                      <button class="btn btn-outline-secondary" onclick="crmForms.quote('${q.quotes_id}', true)">
                        <i class="bi bi-eye"></i>
                      </button>
                    `}
                  </div>
                </div>
              </td>
            </tr>
          `;
        }).join('');
      },
      
      contracts() {
        const tbody = document.getElementById('contractTbody');
        tbody.innerHTML = state.contracts.map(ct => {
          const project = state.cache.projectMap.get(ct.project_id);
          const customer = state.cache.customerMap.get(ct.customer_id);
          const canEdit = utils.canEdit(ct);
          return `
            <tr>
              <td>${ct.contract_id}</td>
              <td class="text-start fw-medium">${project ? project.project_name : ct.project_id}</td>
              <td class="d-none d-md-table-cell">${customer ? customer.name : ct.customer_id}</td>
              <td>${utils.money(ct.value)}</td>
              <td><span class="badge bg-success">${ct.status || ''}</span></td>
              <td>
                <div class="d-flex flex-column gap-1">
                  ${utils.getPermissionBadge(ct)}
                  <div class="btn-group btn-group-sm">
                    ${canEdit ? `
                      <button class="btn btn-outline-secondary" onclick="crmForms.contract('${ct.contract_id}')">
                        <i class="bi bi-pencil-square"></i>
                      </button>
                      <button class="btn btn-outline-danger" onclick="handlers.deleteContract('${ct.contract_id}')">
                        <i class="bi bi-trash"></i>
                      </button>
                    ` : `
                      <button class="btn btn-outline-secondary" onclick="crmForms.contract('${ct.contract_id}', true)">
                        <i class="bi bi-eye"></i>
                      </button>
                    `}
                  </div>
                </div>
              </td>
            </tr>
          `;
        }).join('');
      },
      
      users() {
        // Chỉ admin/BOM mới thấy Users tab
        const canSeeUsers = ['admin', 'BOM'].includes(state.currentUser.role);
        document.getElementById('navUsers').style.display = canSeeUsers ? '' : 'none';
        
        if (!canSeeUsers) return;
        
        const tbody = document.getElementById('userTbody');
        tbody.innerHTML = state.users.map(u => `
          <tr>
            <td class="text-start">${u.email}</td>
            <td><span class="badge bg-primary">${u.role || ''}</span></td>
            <td>${u.active ? '<i class="bi bi-check-circle text-success"></i>' : '<i class="bi bi-x-circle text-danger"></i>'}</td>
            <td>
              <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-secondary" onclick="crmForms.user('${u.id}')">
                  <i class="bi bi-pencil-square"></i>
                </button>
                <button class="btn btn-outline-danger" onclick="handlers.deleteUser('${u.id}')">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        `).join('');
      }
    };
